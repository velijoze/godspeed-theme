{% comment %}
  Admin Dashboard Section
  Centralized management interface for all tools and APIs
{% endcomment %}

<div data-section-id="{{ section.id }}" data-section-type="section-admin-dashboard" style="{% if section.settings.margin_top != blank %}margin-top: {{section.settings.margin_top}}px;{%endif%} {% if section.settings.margin_bottom != blank %}margin-bottom: {{section.settings.margin_bottom}}px;{% endif %}">
  <div class="section-admin-dashboard mt-all">
    <div class="container container-v2">
      <div class="row justify-content-center">
        <div class="col-lg-12 col-md-12 col-sm-12">
          
          <div class="dashboard-wrapper">
            <!-- Navigation Pills -->
            <div class="admin-navigation mb-4">
              <div class="nav-pills">
                <button class="nav-pill active" data-section="overview">
                  <i class="fa fa-dashboard"></i> Overview
                </button>
                <button class="nav-pill" data-section="customer-tools">
                  <i class="fa fa-users"></i> Customer Tools
                </button>
                <button class="nav-pill" data-section="integrations">
                  <i class="fa fa-plug"></i> Integrations
                </button>
                <button class="nav-pill" data-section="monitoring">
                  <i class="fa fa-line-chart"></i> Monitoring
                </button>
              </div>
            </div>

            <!-- Overview Section -->
            <div class="admin-section active" id="overview-section">
              <div class="section-header">
                <h3>System Overview</h3>
                <p class="section-description">Quick status check and key metrics for all your tools</p>
              </div>

              <div class="row">
                <!-- System Health -->
                <div class="col-lg-8 col-md-12 mb-4">
                  <div class="admin-card">
                    <div class="card-header">
                      <h4>System Health</h4>
                      <span class="status-indicator online">All Systems Online</span>
                    </div>
                    <div class="status-grid">
                      <div class="status-item">
                        <div class="status-icon success">
                          <i class="fa fa-check-circle"></i>
                        </div>
                        <div class="status-details">
                          <h5>AI Chat Assistant</h5>
                          <p>Ready to help customers</p>
                        </div>
                        <div class="status-badge online">Live</div>
                      </div>
                      
                      <div class="status-item">
                        <div class="status-icon success">
                          <i class="fa fa-check-circle"></i>
                        </div>
                        <div class="status-details">
                          <h5>Workshop Booking</h5>
                          <p>Google Cloud Connected</p>
                        </div>
                        <div class="status-badge online">Live</div>
                      </div>
                      
                      <div class="status-item">
                        <div class="status-icon success">
                          <i class="fa fa-check-circle"></i>
                        </div>
                        <div class="status-details">
                          <h5>Cube Sync</h5>
                          <p>Product data synchronized</p>
                        </div>
                        <div class="status-badge online">Live</div>
                      </div>
                      
                      <div class="status-item">
                        <div class="status-icon warning">
                          <i class="fa fa-exclamation-triangle"></i>
                        </div>
                        <div class="status-details">
                          <h5>VeloConnect</h5>
                          <p>Needs configuration</p>
                        </div>
                        <div class="status-badge warning">Setup</div>
                      </div>
                    </div>
                  </div>
                </div>
                
                <!-- Key Metrics -->
                <div class="col-lg-4 col-md-12">
                  <div class="admin-card">
                    <div class="card-header">
                      <h4>Today's Activity</h4>
                      <button class="btn-refresh" onclick="updateMetrics()">
                        <i class="fa fa-refresh"></i>
                      </button>
                    </div>
                    <div class="metrics-list">
                      <div class="metric-item">
                        <div class="metric-icon">
                          <i class="fa fa-comments"></i>
                        </div>
                        <div class="metric-data">
                          <div class="metric-value" id="chat-sessions-count">0</div>
                          <div class="metric-label">Chat Sessions</div>
                        </div>
                      </div>
                      
                      <div class="metric-item">
                        <div class="metric-icon">
                          <i class="fa fa-calendar"></i>
                        </div>
                        <div class="metric-data">
                          <div class="metric-value" id="bookings-count">0</div>
                          <div class="metric-label">Bookings</div>
                        </div>
                      </div>
                      
                      <div class="metric-item">
                        <div class="metric-icon">
                          <i class="fa fa-exclamation-triangle"></i>
                        </div>
                        <div class="metric-data">
                          <div class="metric-value" id="sync-conflicts-count">2</div>
                          <div class="metric-label">Sync Conflicts</div>
                        </div>
                      </div>
                      
                      <div class="metric-item">
                        <div class="metric-icon">
                          <i class="fa fa-plus-circle"></i>
                        </div>
                        <div class="metric-data">
                          <div class="metric-value" id="new-products-count">2</div>
                          <div class="metric-label">New Products</div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Quick Actions -->
              <div class="row">
                <div class="col-12">
                  <div class="admin-card">
                    <div class="card-header">
                      <h4>Quick Actions</h4>
                      <p>Common tasks and system checks</p>
                    </div>
                    <div class="quick-actions-grid">
                      <button class="quick-action-btn" onclick="showSyncStatus()">
                        <i class="fa fa-refresh"></i>
                        <span>Data Sync Status</span>
                        <small>Check integration sync status</small>
                      </button>
                      <button class="quick-action-btn" onclick="viewLogs()">
                        <i class="fa fa-list-alt"></i>
                        <span>System Logs</span>
                        <small>View recent system activity</small>
                      </button>
                      <button class="quick-action-btn" onclick="checkAPIs()">
                        <i class="fa fa-stethoscope"></i>
                        <span>Health Check</span>
                        <small>Test all API connections</small>
                      </button>
                      <button class="quick-action-btn" onclick="testAIChat()">
                        <i class="fa fa-robot"></i>
                        <span>Test AI Chat</span>
                        <small>Open chat widget for testing</small>
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Customer Tools Section -->
            <div class="admin-section" id="customer-tools-section">
              <div class="section-header">
                <h3>Customer-Facing Tools</h3>
                <p class="section-description">Configure tools that directly interact with your customers</p>
              </div>

              <div class="tools-grid">
                <!-- AI Chat Assistant -->
                <div class="tool-card">
                  <div class="tool-icon">
                    <i class="fa fa-comments"></i>
                  </div>
                  <div class="tool-content">
                    <h4>AI Chat Assistant</h4>
                    <p class="tool-description">Automated customer support using AI to help with product questions and booking services</p>
                    <div class="tool-tips">
                      <h5>How to use:</h5>
                      <ul>
                        <li>Configure your AI provider (OpenAI, Claude, or Gemini)</li>
                        <li>Set system prompts specific to your e-bike business</li>
                        <li>Test the connection and customize chat appearance</li>
                        <li>Monitor chat sessions to improve responses</li>
                      </ul>
                    </div>
                  </div>
                  <div class="tool-actions">
                    <button class="btn btn-primary" onclick="showToolConfig('ai-chat')">
                      <i class="fa fa-cog"></i> Configure
                    </button>
                    <button class="btn btn-outline" onclick="testAIChat()">
                      <i class="fa fa-play"></i> Test
                    </button>
                  </div>
                </div>

                <!-- QR Code Manager -->
                <div class="tool-card">
                  <div class="tool-icon">
                    <i class="fa fa-qrcode"></i>
                  </div>
                  <div class="tool-content">
                    <h4>QR Code Manager</h4>
                    <p class="tool-description">Generate QR codes for products so customers can scan to go directly to product pages</p>
                    <div class="tool-tips">
                      <h5>How to use:</h5>
                      <ul>
                        <li>Search for products to create QR codes</li>
                        <li>Customize size, colors, and error correction</li>
                        <li>Download codes as PNG or SVG files</li>
                        <li>Print codes for in-store displays or catalogs</li>
                      </ul>
                    </div>
                  </div>
                  <div class="tool-actions">
                    <button class="btn btn-primary" onclick="showToolConfig('qr-codes')">
                      <i class="fa fa-cog"></i> Manage QR Codes
                    </button>
                  </div>
                </div>

                <!-- Workshop Booking -->
                <div class="tool-card">
                  <div class="tool-icon">
                    <i class="fa fa-calendar"></i>
                  </div>
                  <div class="tool-content">
                    <h4>Workshop Booking</h4>
                    <p class="tool-description">Manage service appointments across your locations (Lugano, Bellinzona, Locarno, Zurich)</p>
                    <div class="tool-tips">
                      <h5>How to use:</h5>
                      <ul>
                        <li>View upcoming bookings for all locations</li>
                        <li>Confirm, reschedule, or cancel appointments</li>
                        <li>Add notes about customer bikes and services</li>
                        <li>Track booking metrics and trends</li>
                      </ul>
                    </div>
                  </div>
                  <div class="tool-actions">
                    <button class="btn btn-primary" onclick="showToolConfig('workshop-booking')">
                      <i class="fa fa-cog"></i> Manage Bookings
                    </button>
                  </div>
                </div>
              </div>
            </div>

            <!-- Integrations Section -->
            <div class="admin-section" id="integrations-section">
              <div class="section-header">
                <h3>External Integrations</h3>
                <p class="section-description">Connect with suppliers and external systems for product data</p>
              </div>

              <div class="tools-grid">
                <!-- Cube Integration -->
                <div class="tool-card">
                  <div class="tool-icon">
                    <i class="fa fa-cube"></i>
                  </div>
                  <div class="tool-content">
                    <h4>Cube Connect API</h4>
                    <p class="tool-description">Sync bicycle products, pricing, and inventory directly from Cube's system</p>
                    <div class="tool-tips">
                      <h5>How to use:</h5>
                      <ul>
                        <li>Configure OAuth2 credentials or use 24-hour tokens</li>
                        <li>Set sync schedule (hourly, daily, manual)</li>
                        <li>Preview changes before applying to store</li>
                        <li>Handle conflicts between Shopify and Cube data</li>
                      </ul>
                    </div>
                  </div>
                  <div class="tool-actions">
                    <button class="btn btn-primary" onclick="showToolConfig('cube-integration')">
                      <i class="fa fa-cog"></i> Configure Cube
                    </button>
                  </div>
                </div>

                <!-- VeloConnect -->
                <div class="tool-card">
                  <div class="tool-icon">
                    <i class="fa fa-network-wired"></i>
                  </div>
                  <div class="tool-content">
                    <h4>VeloConnect Network</h4>
                    <p class="tool-description">Connect to multiple suppliers: ABUS, Amsler, Chris Sports, Komenda, Magura, Maxxis, Orbea, SKS</p>
                    <div class="tool-tips">
                      <h5>How to use:</h5>
                      <ul>
                        <li>Set up credentials for each supplier individually</li>
                        <li>Configure which suppliers to sync products from</li>
                        <li>Manage product categories per supplier</li>
                        <li>Monitor sync status across all connections</li>
                      </ul>
                    </div>
                  </div>
                  <div class="tool-actions">
                    <button class="btn btn-primary" onclick="showToolConfig('veloconnect')">
                      <i class="fa fa-cog"></i> Configure VeloConnect
                    </button>
                  </div>
                </div>
              </div>
            </div>

            <!-- Monitoring Section -->
            <div class="admin-section" id="monitoring-section">
              <div class="section-header">
                <h3>System Monitoring</h3>
                <p class="section-description">Track performance, view logs, and monitor data synchronization</p>
              </div>

              <!-- Data Sync Status - Main Feature -->
              <div class="sync-status-container mb-4">
                <div class="sync-header">
                  <h4>Data Sync Status</h4>
                  <p class="section-tip">Monitor real-time synchronization between your systems and suppliers</p>
                  <div class="sync-controls">
                    <button class="btn btn-secondary sync-all-btn" onclick="syncAllData()">
                      <i class="fa fa-refresh"></i> Sync All
                    </button>
                    <button class="btn btn-outline" onclick="showSyncDetails()">
                      <i class="fa fa-eye"></i> Preview Sync Changes
                    </button>
                  </div>
                </div>
                
                <div class="sync-grid">
                  <div class="sync-card" data-supplier="cube">
                    <div class="sync-info">
                      <div class="sync-icon">
                        <i class="fa fa-cube"></i>
                      </div>
                      <div class="sync-details">
                        <h5>Cube Connect</h5>
                        <span class="sync-status synced" id="cube-sync-status">Last sync: 2 hours ago</span>
                      </div>
                    </div>
                    <div class="sync-stats">
                      <div class="sync-count" id="cube-product-count">1,234 products</div>
                      <button class="btn btn-sm sync-btn" onclick="syncSupplierData('cube')" title="Sync Cube products">
                        <i class="fa fa-refresh"></i>
                      </button>
                    </div>
                  </div>
                  
                  <div class="sync-card" data-supplier="abus">
                    <div class="sync-info">
                      <div class="sync-icon">
                        <i class="fa fa-shield"></i>
                      </div>
                      <div class="sync-details">
                        <h5>ABUS Security</h5>
                        <span class="sync-status pending" id="abus-sync-status">Pending configuration</span>
                      </div>
                    </div>
                    <div class="sync-stats">
                      <div class="sync-count" id="abus-product-count">0 products</div>
                      <button class="btn btn-sm sync-btn disabled" onclick="configureSupplier('abus')" title="Configure ABUS first">
                        <i class="fa fa-cog"></i>
                      </button>
                    </div>
                  </div>
                  
                  <div class="sync-card" data-supplier="maxxis">
                    <div class="sync-info">
                      <div class="sync-icon">
                        <i class="fa fa-circle"></i>
                      </div>
                      <div class="sync-details">
                        <h5>Maxxis Tires</h5>
                        <span class="sync-status synced" id="maxxis-sync-status">Last sync: 5 hours ago</span>
                      </div>
                    </div>
                    <div class="sync-stats">
                      <div class="sync-count" id="maxxis-product-count">456 products</div>
                      <button class="btn btn-sm sync-btn" onclick="syncSupplierData('maxxis')" title="Sync Maxxis products">
                        <i class="fa fa-refresh"></i>
                      </button>
                    </div>
                  </div>
                  
                  <div class="sync-card" data-supplier="magura">
                    <div class="sync-info">
                      <div class="sync-icon">
                        <i class="fa fa-cog"></i>
                      </div>
                      <div class="sync-details">
                        <h5>Magura Components</h5>
                        <span class="sync-status error" id="magura-sync-status">Sync failed 1 hour ago</span>
                      </div>
                    </div>
                    <div class="sync-stats">
                      <div class="sync-count" id="magura-product-count">289 products</div>
                      <button class="btn btn-sm sync-btn error" onclick="retrySupplierSync('magura')" title="Retry failed sync">
                        <i class="fa fa-exclamation-triangle"></i>
                      </button>
                    </div>
                  </div>
                  
                  <div class="sync-card" data-supplier="workshop">
                    <div class="sync-info">
                      <div class="sync-icon">
                        <i class="fa fa-wrench"></i>
                      </div>
                      <div class="sync-details">
                        <h5>Workshop Bookings</h5>
                        <span class="sync-status synced" id="workshop-sync-status">Real-time sync</span>
                      </div>
                    </div>
                    <div class="sync-stats">
                      <div class="sync-count" id="workshop-booking-count">23 pending</div>
                      <button class="btn btn-sm sync-btn" onclick="syncWorkshopData()" title="Refresh booking data">
                        <i class="fa fa-calendar"></i>
                      </button>
                    </div>
                  </div>
                  
                  <div class="sync-card" data-supplier="chat">
                    <div class="sync-info">
                      <div class="sync-icon">
                        <i class="fa fa-comments"></i>
                      </div>
                      <div class="sync-details">
                        <h5>Chat Sessions</h5>
                        <span class="sync-status synced" id="chat-sync-status">Live tracking</span>
                      </div>
                    </div>
                    <div class="sync-stats">
                      <div class="sync-count" id="chat-session-count">Active sessions</div>
                      <button class="btn btn-sm sync-btn" onclick="refreshChatMetrics()" title="Refresh chat metrics">
                        <i class="fa fa-refresh"></i>
                      </button>
                    </div>
                  </div>
                </div>
                
                <div class="sync-summary">
                  <div class="summary-stat">
                    <span class="stat-label">Total Products:</span>
                    <span class="stat-value" id="total-products">1,979</span>
                  </div>
                  <div class="summary-stat">
                    <span class="stat-label">Active Suppliers:</span>
                    <span class="stat-value" id="active-suppliers">3/10</span>
                  </div>
                  <div class="summary-stat">
                    <span class="stat-label">Last Full Sync:</span>
                    <span class="stat-value" id="last-full-sync">Today at 14:30</span>
                  </div>
                  <div class="summary-stat">
                    <span class="stat-label">Sync Status:</span>
                    <span class="stat-value sync-health-good" id="overall-sync-health">Good</span>
                  </div>
                </div>
              </div>

              <!-- Secondary Monitoring Tools -->
              <div class="monitoring-grid">
                <!-- System Logs -->
                <div class="monitoring-card">
                  <div class="monitoring-icon">
                    <i class="fa fa-list-alt"></i>
                  </div>
                  <div class="monitoring-content">
                    <h4>System Logs</h4>
                    <p>View detailed logs of system events, errors, and API calls</p>
                    <div class="recent-logs" id="recent-logs-preview">
                      <div class="log-preview">
                        <span class="log-level info">INFO</span>
                        <span class="log-message">AI Chat: New conversation started</span>
                        <span class="log-time">2 min ago</span>
                      </div>
                      <div class="log-preview">
                        <span class="log-level success">SUCCESS</span>
                        <span class="log-message">Cube Sync: 15 products updated</span>
                        <span class="log-time">25 min ago</span>
                      </div>
                    </div>
                  </div>
                  <button class="btn btn-outline" onclick="viewLogs()">
                    <i class="fa fa-eye"></i> View All Logs
                  </button>
                </div>

                <!-- Performance Monitor -->
                <div class="monitoring-card">
                  <div class="monitoring-icon">
                    <i class="fa fa-tachometer"></i>
                  </div>
                  <div class="monitoring-content">
                    <h4>Performance Monitor</h4>
                    <p>API response times and system performance metrics</p>
                    <div class="performance-metrics">
                      <div class="perf-metric">
                        <span class="perf-label">Avg Response:</span>
                        <span class="perf-value" id="avg-response-time">245ms</span>
                      </div>
                      <div class="perf-metric">
                        <span class="perf-label">Success Rate:</span>
                        <span class="perf-value" id="success-rate">99.2%</span>
                      </div>
                      <div class="perf-metric">
                        <span class="perf-label">Uptime:</span>
                        <span class="perf-value" id="system-uptime">99.9%</span>
                      </div>
                    </div>
                  </div>
                  <button class="btn btn-outline" onclick="checkAPIs()">
                    <i class="fa fa-stethoscope"></i> Run Health Check
                  </button>
                </div>
              </div>
            </div>

            <!-- Configuration Modal Container -->
            <div id="config-modal-container">
            <!-- Tool Configuration -->
            <div class="configuration-modal" id="tool-configuration-modal" style="display: none;">
              <div class="config-modal-content">
                <div class="config-modal-header">
                  <h4 id="config-modal-title">Tool Configuration</h4>
                  <button class="close-btn" onclick="closeToolConfig()">Ã—</button>
                </div>
                
                <div class="tool-configuration">
                  <h4 class="section-title section-title-{{ section.id }} mb-4">Tool Configuration</h4>
                  
                  <div class="config-tabs">
                    <div class="tab-navigation">
                      <button class="tab-btn active" data-tab="ai-chat">AI Chat</button>
                      <button class="tab-btn" data-tab="workshop-booking">Workshop Booking</button>
                      <button class="tab-btn" data-tab="qr-codes">QR Codes</button>
                      <button class="tab-btn" data-tab="cube-integration">Cube Integration</button>
                      <button class="tab-btn" data-tab="veloconnect">VeloConnect</button>
                    </div>
                    
                    <div class="tab-content">
                      <!-- AI Chat Configuration -->
                      <div class="tab-pane active" id="ai-chat-config">
                        <div class="config-form">
                          <div class="alert alert-warning mb-4">
                            <strong>AI Chat Setup Required</strong><br>
                            To enable the AI Chat Assistant, you need to configure an AI API provider below.
                          </div>
                          
                          <div class="row">
                            <div class="col-lg-6 col-md-6 col-sm-12 mb-3">
                              <label class="form-label">AI Provider</label>
                              <select class="form-control" id="ai-provider-select">
                                <option value="">Select AI Provider</option>
                                <option value="openai">OpenAI (ChatGPT)</option>
                                <option value="claude">Anthropic Claude</option>
                                <option value="gemini">Google Gemini</option>
                              </select>
                            </div>
                            <div class="col-lg-6 col-md-6 col-sm-12 mb-3">
                              <label class="form-label">API Key</label>
                              <input type="password" class="form-control" placeholder="Enter your API key" id="ai-api-key">
                              <small class="form-text text-muted">Your API key is encrypted and stored securely</small>
                            </div>
                          </div>
                          
                          <div class="row">
                            <div class="col-lg-6 col-md-6 col-sm-12 mb-3">
                              <label class="form-label">Chat Title</label>
                              <input type="text" class="form-control" value="Godspeed E-Bike Expert" id="chat-title-input">
                            </div>
                            <div class="col-lg-6 col-md-6 col-sm-12 mb-3">
                              <label class="form-label">Model</label>
                              <select class="form-control" id="ai-model-select">
                                <option value="gpt-4">GPT-4 (Recommended)</option>
                                <option value="gpt-3.5-turbo">GPT-3.5 Turbo (Faster)</option>
                                <option value="claude-3-sonnet">Claude 3 Sonnet</option>
                                <option value="gemini-pro">Gemini Pro</option>
                              </select>
                            </div>
                          </div>
                          
                          <div class="row">
                            <div class="col-12 mb-3">
                              <label class="form-label">System Prompt</label>
                              <textarea class="form-control" rows="4" id="system-prompt-input">You are an expert assistant for Godspeed E-Bike shop in Switzerland. You help customers with:
- E-bike recommendations based on needs
- Technical specifications and comparisons
- Service appointments and maintenance
- Pricing in Swiss Francs (CHF)
- Local cycling routes and tips

Always be helpful, friendly, and knowledgeable about e-bikes, cycling, and Swiss locations.</textarea>
                            </div>
                          </div>
                          
                          <div class="row">
                            <div class="col-lg-6 col-md-6 col-sm-12 mb-3">
                              <label class="form-label">Welcome Message</label>
                              <textarea class="form-control" rows="2" id="welcome-message-input">Hello! I'm your Godspeed e-bike expert. How can I help you find the perfect bike or schedule service today?</textarea>
                            </div>
                            <div class="col-lg-6 col-md-6 col-sm-12 mb-3">
                              <label class="form-label">Max Messages per Conversation</label>
                              <input type="number" class="form-control" value="20" min="5" max="50" id="max-messages-input">
                            </div>
                          </div>
                          
                          <div class="row">
                            <div class="col-lg-6 col-md-6 col-sm-12 mb-3">
                              <label class="form-label">Button Color</label>
                              <input type="color" class="form-control" value="#333333" id="button-color-input">
                            </div>
                            <div class="col-lg-6 col-md-6 col-sm-12 mb-3">
                              <label class="form-label">Header Color</label>
                              <input type="color" class="form-control" value="#f8f9fa" id="header-color-input">
                            </div>
                          </div>
                          
                          <div class="form-actions">
                            <button class="btn btn-test" onclick="testAIChatConnection()" id="test-ai-btn">
                              <i class="fa fa-plug"></i> Test Connection
                            </button>
                            <button class="btn btn-save" onclick="saveAIChatConfig()">
                              <i class="fa fa-save"></i> Save AI Chat Settings
                            </button>
                          </div>
                          
                          <div class="mt-4" id="ai-chat-status" style="display: none;">
                            <!-- Status messages will appear here -->
                          </div>
                          
                          <!-- Recent Chat Sessions -->
                          <div class="mt-5">
                            <h5>Recent Chat Sessions</h5>
                            <div class="chat-sessions-list" id="recent-chat-sessions">
                              <div class="session-item">
                                <div class="session-info">
                                  <span class="session-time">2 hours ago</span>
                                  <span class="session-messages">5 messages</span>
                                </div>
                                <div class="session-preview">Customer asked about e-mountain bike recommendations for Swiss Alps...</div>
                                <button class="btn btn-sm btn-outline" onclick="viewChatSession('session-1')">View</button>
                              </div>
                              <div class="session-item">
                                <div class="session-info">
                                  <span class="session-time">1 day ago</span>
                                  <span class="session-messages">8 messages</span>
                                </div>
                                <div class="session-preview">Service appointment inquiry for battery maintenance...</div>
                                <button class="btn btn-sm btn-outline" onclick="viewChatSession('session-2')">View</button>
                              </div>
                            </div>
                            <button class="btn btn-secondary btn-sm mt-2" onclick="loadMoreChatSessions()">Load More Sessions</button>
                          </div>
                        </div>
                      </div>
                      
                      <!-- Workshop Booking Configuration -->
                      <div class="tab-pane" id="workshop-booking-config">
                        <div class="config-form">
                          <!-- Recent Bookings -->
                          <div class="row mb-4">
                            <div class="col-12">
                              <h5>Recent Service Bookings</h5>
                              <div class="bookings-list" id="recent-bookings">
                                <div class="booking-item">
                                  <div class="booking-info">
                                    <div class="booking-date">Today, 14:00</div>
                                    <div class="booking-service">E-Bike Maintenance</div>
                                    <div class="booking-customer">M. Fischer - Lugano</div>
                                  </div>
                                  <div class="booking-actions">
                                    <span class="booking-status confirmed">Confirmed</span>
                                    <button class="btn btn-sm btn-outline" onclick="viewBooking('booking-1')">View</button>
                                  </div>
                                </div>
                                <div class="booking-item">
                                  <div class="booking-info">
                                    <div class="booking-date">Tomorrow, 10:30</div>
                                    <div class="booking-service">Battery Diagnostics</div>
                                    <div class="booking-customer">S. Weber - Bellinzona</div>
                                  </div>
                                  <div class="booking-actions">
                                    <span class="booking-status pending">Pending</span>
                                    <button class="btn btn-sm btn-outline" onclick="viewBooking('booking-2')">View</button>
                                  </div>
                                </div>
                                <div class="booking-item">
                                  <div class="booking-info">
                                    <div class="booking-date">Jan 30, 15:15</div>
                                    <div class="booking-service">Complete Service</div>
                                    <div class="booking-customer">A. Rossi - Locarno</div>
                                  </div>
                                  <div class="booking-actions">
                                    <span class="booking-status confirmed">Confirmed</span>
                                    <button class="btn btn-sm btn-outline" onclick="viewBooking('booking-3')">View</button>
                                  </div>
                                </div>
                              </div>
                              <button class="btn btn-secondary btn-sm" onclick="loadMoreBookings()">Load More Bookings</button>
                            </div>
                          </div>
                          
                          <!-- API Configuration -->
                          <div class="row">
                            <div class="col-lg-6 col-md-6 col-sm-12 mb-3">
                              <label class="form-label">Google Cloud Function URL</label>
                              <input type="text" class="form-control" value="https://bookings-api-802427545823.europe-west6.run.app/bookings/service" readonly>
                            </div>
                            <div class="col-lg-6 col-md-6 col-sm-12 mb-3">
                              <label class="form-label">API Status</label>
                              <span class="status-indicator online" id="workshop-api-status">Online</span>
                            </div>
                          </div>
                          <div class="row">
                            <div class="col-lg-6 col-md-6 col-sm-12 mb-3">
                              <label class="form-label">Service Locations</label>
                              <div class="location-list">
                                <div class="location-item">
                                  <input type="checkbox" checked> Lugano Workshop
                                </div>
                                <div class="location-item">
                                  <input type="checkbox" checked> Bellinzona Store
                                </div>
                                <div class="location-item">
                                  <input type="checkbox" checked> Locarno Store
                                </div>
                                <div class="location-item">
                                  <input type="checkbox" checked> Zurich Store
                                </div>
                              </div>
                            </div>
                            <div class="col-lg-6 col-md-6 col-sm-12 mb-3">
                              <label class="form-label">Booking Hours</label>
                              <input type="text" class="form-control" value="09:00 - 17:00 (Mon-Fri)" readonly>
                            </div>
                          </div>
                          <div class="form-actions">
                            <button class="btn btn-test" onclick="testWorkshopAPI()">
                              <i class="fa fa-plug"></i> Test Workshop API
                            </button>
                            <button class="btn btn-secondary" onclick="refreshBookings()">
                              <i class="fa fa-refresh"></i> Refresh Bookings
                            </button>
                          </div>
                        </div>
                      </div>

                      <!-- QR Code Management -->
                      <div class="tab-pane" id="qr-codes-config">
                        <div class="config-form">
                          <div class="alert alert-info mb-4">
                            <strong>ðŸ“± QR Code Integration</strong><br>
                            Generate QR codes for products so customers can scan and be taken directly to the product page.
                          </div>
                          
                          <div class="row mb-4">
                            <div class="col-lg-8 col-md-8 col-sm-12">
                              <label class="form-label">Product Search</label>
                              <input type="text" class="form-control" placeholder="Search products to generate QR codes..." id="product-search-input">
                            </div>
                            <div class="col-lg-4 col-md-4 col-sm-12">
                              <label class="form-label">&nbsp;</label>
                              <button class="btn btn-primary btn-block" onclick="searchProducts()">
                                <i class="fa fa-search"></i> Search Products
                              </button>
                            </div>
                          </div>
                          
                          <!-- QR Code Generation -->
                          <div class="row mb-4">
                            <div class="col-lg-6 col-md-6 col-sm-12">
                              <h5>Generate QR Code</h5>
                              <div class="qr-generator">
                                <input type="text" class="form-control mb-2" placeholder="Product URL or Handle" id="qr-product-url">
                                <input type="text" class="form-control mb-2" placeholder="QR Code Label (optional)" id="qr-label">
                                <button class="btn btn-success" onclick="generateQRCode()">
                                  <i class="fa fa-qrcode"></i> Generate QR Code
                                </button>
                              </div>
                            </div>
                            <div class="col-lg-6 col-md-6 col-sm-12">
                              <h5>QR Code Preview</h5>
                              <div class="qr-preview" id="qr-preview">
                                <div class="qr-placeholder">
                                  <i class="fa fa-qrcode fa-3x"></i>
                                  <p>QR Code will appear here</p>
                                </div>
                              </div>
                              <div class="qr-actions mt-2" id="qr-actions" style="display: none;">
                                <button class="btn btn-sm btn-primary" onclick="downloadQRCode()">
                                  <i class="fa fa-download"></i> Download PNG
                                </button>
                                <button class="btn btn-sm btn-secondary" onclick="downloadQRCodeSVG()">
                                  <i class="fa fa-vector-square"></i> Download SVG
                                </button>
                              </div>
                            </div>
                          </div>
                          
                          <!-- Existing QR Codes -->
                          <div class="row">
                            <div class="col-12">
                              <h5>Existing QR Codes</h5>
                              <div class="qr-codes-list" id="existing-qr-codes">
                                <div class="qr-code-item">
                                  <div class="qr-info">
                                    <div class="qr-product">Cube Stereo Hybrid 140 HPC</div>
                                    <div class="qr-url">https://godspeed-bike.com/products/cube-stereo-hybrid-140</div>
                                    <div class="qr-created">Created: 3 days ago</div>
                                  </div>
                                  <div class="qr-thumbnail">
                                    <canvas width="60" height="60" id="qr-thumb-1"></canvas>
                                  </div>
                                  <div class="qr-actions">
                                    <button class="btn btn-sm btn-outline" onclick="viewQRCode('qr-1')">View</button>
                                    <button class="btn btn-sm btn-outline" onclick="downloadQR('qr-1')">Download</button>
                                    <button class="btn btn-sm btn-danger" onclick="deleteQRCode('qr-1')">Delete</button>
                                  </div>
                                </div>
                                <div class="qr-code-item">
                                  <div class="qr-info">
                                    <div class="qr-product">Trek Fuel EXe 9.8 XT</div>
                                    <div class="qr-url">https://godspeed-bike.com/products/trek-fuel-exe</div>
                                    <div class="qr-created">Created: 1 week ago</div>
                                  </div>
                                  <div class="qr-thumbnail">
                                    <canvas width="60" height="60" id="qr-thumb-2"></canvas>
                                  </div>
                                  <div class="qr-actions">
                                    <button class="btn btn-sm btn-outline" onclick="viewQRCode('qr-2')">View</button>
                                    <button class="btn btn-sm btn-outline" onclick="downloadQR('qr-2')">Download</button>
                                    <button class="btn btn-sm btn-danger" onclick="deleteQRCode('qr-2')">Delete</button>
                                  </div>
                                </div>
                              </div>
                              <button class="btn btn-secondary btn-sm" onclick="loadMoreQRCodes()">Load More QR Codes</button>
                            </div>
                          </div>
                          
                          <!-- QR Code Settings -->
                          <div class="row mt-4">
                            <div class="col-12">
                              <h5>QR Code Settings</h5>
                              <div class="row">
                                <div class="col-lg-3 col-md-6 col-sm-12 mb-3">
                                  <label class="form-label">Size</label>
                                  <select class="form-control" id="qr-size">
                                    <option value="200">Small (200px)</option>
                                    <option value="400" selected>Medium (400px)</option>
                                    <option value="600">Large (600px)</option>
                                    <option value="1000">Extra Large (1000px)</option>
                                  </select>
                                </div>
                                <div class="col-lg-3 col-md-6 col-sm-12 mb-3">
                                  <label class="form-label">Error Correction</label>
                                  <select class="form-control" id="qr-error-correction">
                                    <option value="L">Low (7%)</option>
                                    <option value="M" selected>Medium (15%)</option>
                                    <option value="Q">Quartile (25%)</option>
                                    <option value="H">High (30%)</option>
                                  </select>
                                </div>
                                <div class="col-lg-3 col-md-6 col-sm-12 mb-3">
                                  <label class="form-label">Foreground Color</label>
                                  <input type="color" class="form-control" value="#000000" id="qr-fg-color">
                                </div>
                                <div class="col-lg-3 col-md-6 col-sm-12 mb-3">
                                  <label class="form-label">Background Color</label>
                                  <input type="color" class="form-control" value="#ffffff" id="qr-bg-color">
                                </div>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                      
                      <!-- Cube Integration Configuration -->
                      <div class="tab-pane" id="cube-integration-config">
                        <div class="config-form">
                          <div class="row">
                            <div class="col-lg-6 col-md-6 col-sm-12 mb-3">
                              <label class="form-label">API Status</label>
                              <span class="status-indicator online">Connected</span>
                            </div>
                            <div class="col-lg-6 col-md-6 col-sm-12 mb-3">
                              <label class="form-label">Last Sync</label>
                              <span class="last-sync">2 hours ago</span>
                            </div>
                          </div>
                          <div class="row">
                            <div class="col-lg-6 col-md-6 col-sm-12 mb-3">
                              <label class="form-label">Products Synced</label>
                              <span class="sync-count">1,247 products</span>
                            </div>
                            <div class="col-lg-6 col-md-6 col-sm-12 mb-3">
                              <label class="form-label">Sync Frequency</label>
                              <select class="form-control">
                                <option>Every 2 hours</option>
                                <option>Every 4 hours</option>
                                <option>Daily</option>
                                <option>Manual</option>
                              </select>
                            </div>
                          </div>
                          <button class="btn btn-sync" onclick="syncCubeProducts()">Sync Products Now</button>
                        </div>
                      </div>
                      
                      <!-- VeloConnect Configuration -->
                      <div class="tab-pane" id="veloconnect-config">
                        <div class="config-form">
                          <div class="row">
                            <div class="col-lg-6 col-md-6 col-sm-12 mb-3">
                              <label class="form-label">API Status</label>
                              <span class="status-indicator pending">Configuration Required</span>
                            </div>
                            <div class="col-lg-6 col-md-6 col-sm-12 mb-3">
                              <label class="form-label">Suppliers Connected</label>
                              <span class="supplier-count">1 of 12</span>
                            </div>
                          </div>
                          <div class="row">
                            <div class="col-lg-12 col-md-12 col-sm-12 mb-3">
                              <label class="form-label">Available Suppliers</label>
                              <div class="supplier-grid">
                                <div class="supplier-item configured">
                                  <span class="supplier-name">Cube Bikes</span>
                                  <span class="supplier-status">Connected</span>
                                </div>
                                <div class="supplier-item pending">
                                  <span class="supplier-name">ABUS</span>
                                  <span class="supplier-status">Setup Required</span>
                                </div>
                                <div class="supplier-item pending">
                                  <span class="supplier-name">Orbea</span>
                                  <span class="supplier-status">Setup Required</span>
                                </div>
                                <div class="supplier-item pending">
                                  <span class="supplier-name">Maxxis</span>
                                  <span class="supplier-status">Setup Required</span>
                                </div>
                              </div>
                            </div>
                          </div>
                          <button class="btn btn-configure" onclick="configureVeloConnect()">Configure VeloConnect</button>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
  .section-admin-dashboard {
    padding: 80px 0;
    background: #fff;
  }
  
  .section-admin-dashboard .title-{{ section.id }} {
    color: {{ section.settings.color_title | default: '#333' }};
    font-size: 36px;
    font-weight: 700;
    line-height: 1.2;
  }
  
  .section-admin-dashboard .subtitle-{{ section.id }} {
    color: {{ section.settings.color_subtitle | default: '#6c757d' }};
    font-size: 18px;
    line-height: 1.6;
    max-width: 600px;
    margin: 0 auto;
  }

  /* Alert styles */
  .alert {
    padding: 12px 16px;
    border-radius: 8px;
    margin-bottom: 16px;
    border: 1px solid transparent;
  }
  
  .alert-info {
    background: #d1ecf1;
    color: #0c5460;
    border-color: #b8daff;
  }
  
  .alert-warning {
    background: #fff3cd;
    color: #856404;
    border-color: #ffeaa7;
  }
  
  .alert-success {
    background: #d4edda;
    color: #155724;
    border-color: #c3e6cb;
  }
  
  .alert-danger {
    background: #f8d7da;
    color: #721c24;
    border-color: #f5c6cb;
  }

  /* Form styles */
  .form-actions {
    display: flex;
    gap: 10px;
    margin-top: 20px;
  }

  .btn-test, .btn-save {
    padding: 10px 20px;
    border: none;
    border-radius: 6px;
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 8px;
    transition: all 0.3s ease;
  }

  .btn-test {
    background: #17a2b8;
    color: white;
  }

  .btn-save {
    background: #28a745;
    color: white;
  }

  .btn-test:hover {
    background: #138496;
  }

  .btn-save:hover {
    background: #218838;
  }

  /* Session/Booking item styles */
  .session-item, .booking-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 16px;
    border: 1px solid #e9ecef;
    border-radius: 8px;
    margin-bottom: 10px;
    background: #f8f9fa;
  }

  .session-info, .booking-info {
    flex: 1;
  }

  .session-time, .booking-date {
    font-size: 12px;
    color: #6c757d;
    font-weight: 500;
  }

  .session-messages, .booking-service {
    font-size: 11px;
    color: #6c757d;
    margin-top: 2px;
  }

  .session-preview, .booking-customer {
    font-size: 13px;
    color: #333;
    margin-top: 4px;
  }

  .booking-actions {
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .booking-status {
    padding: 3px 8px;
    border-radius: 12px;
    font-size: 11px;
    font-weight: 600;
    text-transform: uppercase;
  }

  .booking-status.confirmed {
    background: #d4edda;
    color: #155724;
  }

  .booking-status.pending {
    background: #fff3cd;
    color: #856404;
  }

  .btn-outline {
    background: white;
    border: 1px solid #dee2e6;
    color: #333;
    padding: 6px 12px;
    border-radius: 4px;
    font-size: 12px;
    cursor: pointer;
    transition: all 0.3s ease;
  }

  .btn-outline:hover {
    background: #f8f9fa;
    border-color: #333;
  }

  /* QR Code styles */
  .qr-preview {
    border: 2px dashed #dee2e6;
    border-radius: 8px;
    padding: 20px;
    text-align: center;
    min-height: 200px;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .qr-placeholder {
    color: #6c757d;
    text-align: center;
  }

  .qr-code-display {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 10px;
  }

  .qr-info {
    font-size: 12px;
    color: #6c757d;
    text-align: center;
  }

  .qr-url {
    font-family: monospace;
    background: #f8f9fa;
    padding: 4px 8px;
    border-radius: 4px;
    margin-bottom: 4px;
  }

  .qr-code-item {
    display: grid;
    grid-template-columns: 1fr 60px auto;
    gap: 15px;
    align-items: center;
    padding: 15px;
    border: 1px solid #e9ecef;
    border-radius: 8px;
    margin-bottom: 10px;
    background: white;
  }

  .qr-info .qr-product {
    font-weight: 600;
    color: #333;
    margin-bottom: 4px;
  }

  .qr-info .qr-url {
    font-size: 11px;
    font-family: monospace;
    color: #007bff;
    margin-bottom: 4px;
  }

  .qr-info .qr-created {
    font-size: 10px;
    color: #6c757d;
  }

  .qr-thumbnail {
    width: 60px;
    height: 60px;
    border: 1px solid #e9ecef;
    border-radius: 4px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: #f8f9fa;
  }

  .qr-actions {
    display: flex;
    flex-direction: column;
    gap: 5px;
  }

  .qr-actions .btn {
    font-size: 11px;
    padding: 4px 8px;
  }

  .btn-danger {
    background: #dc3545;
    color: white;
  }

  .btn-danger:hover {
    background: #c82333;
  }
  
  .dashboard-wrapper {
    background: #f8f9fa;
    padding: 2rem;
    border-radius: 16px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.1);
  }
  
  .section-title-{{ section.id }} {
    color: {{ section.settings.color_title | default: '#333' }};
    font-size: 20px;
    font-weight: 600;
    margin-bottom: 1rem;
  }
  
  /* Status Grid */
  .status-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 1rem;
    margin-bottom: 2rem;
  }
  
  .status-card {
    background: white;
    padding: 1.5rem;
    border-radius: 12px;
    border: 1px solid #e9ecef;
    display: flex;
    align-items: center;
    gap: 1rem;
    transition: all 0.3s ease;
  }
  
  .status-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.1);
  }
  
  .status-card.status-online {
    border-left: 4px solid #28a745;
  }
  
  .status-card.status-pending {
    border-left: 4px solid #ffc107;
  }
  
  .status-card.status-offline {
    border-left: 4px solid #dc3545;
  }
  
  .status-icon {
    font-size: 2rem;
    color: #28a745;
  }
  
  .status-card.status-pending .status-icon {
    color: #ffc107;
  }
  
  .status-card.status-offline .status-icon {
    color: #dc3545;
  }
  
  .status-content h5 {
    margin: 0 0 0.5rem 0;
    font-size: 16px;
    font-weight: 600;
    color: #333;
  }
  
  .status-content p {
    margin: 0 0 0.5rem 0;
    font-size: 14px;
    color: #6c757d;
  }
  
  .status-badge {
    background: #28a745;
    color: white;
    padding: 0.25rem 0.75rem;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 600;
  }
  
  .status-card.status-pending .status-badge {
    background: #ffc107;
    color: #333;
  }
  
  /* Quick Actions */
  .action-buttons {
    display: flex;
    gap: 1rem;
    flex-wrap: wrap;
  }
  
  .btn-action {
    background: {{ section.settings.color_title | default: '#333' }};
    color: white;
    border: none;
    padding: 0.75rem 1.5rem;
    border-radius: 8px;
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }
  
  .btn-action:hover {
    background: #555;
    transform: translateY(-1px);
  }
  
  /* System Metrics */
  .metric-cards {
    display: grid;
    gap: 1rem;
  }
  
  .metric-card {
    background: white;
    padding: 1.5rem;
    border-radius: 12px;
    border: 1px solid #e9ecef;
    text-align: center;
  }
  
  .metric-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
  }
  
  .metric-header h5 {
    margin: 0;
    font-size: 14px;
    color: #6c757d;
    font-weight: 500;
  }
  
  .metric-header i {
    font-size: 1.5rem;
    color: {{ section.settings.color_title | default: '#333' }};
  }
  
  .metric-value {
    font-size: 2rem;
    font-weight: 700;
    color: #333;
    margin-bottom: 0.5rem;
  }
  
  .metric-change {
    font-size: 12px;
    font-weight: 500;
  }
  
  .metric-change.positive {
    color: #28a745;
  }
  
  .metric-change.negative {
    color: #dc3545;
  }
  
  .metric-change.neutral {
    color: #6c757d;
  }
  
  /* Configuration Tabs */
  .config-tabs {
    background: white;
    border-radius: 12px;
    overflow: hidden;
    border: 1px solid #e9ecef;
  }
  
  .tab-navigation {
    display: flex;
    background: #f8f9fa;
    border-bottom: 1px solid #e9ecef;
  }
  
  .tab-btn {
    background: none;
    border: none;
    padding: 1rem 1.5rem;
    font-size: 14px;
    font-weight: 500;
    color: #6c757d;
    cursor: pointer;
    transition: all 0.3s ease;
    border-bottom: 3px solid transparent;
  }
  
  .tab-btn.active {
    color: {{ section.settings.color_title | default: '#333' }};
    border-bottom-color: {{ section.settings.color_title | default: '#333' }};
    background: white;
  }
  
  .tab-btn:hover {
    color: #333;
    background: #e9ecef;
  }
  
  .tab-content {
    padding: 2rem;
  }
  
  .tab-pane {
    display: none;
  }
  
  .tab-pane.active {
    display: block;
  }
  
  /* Configuration Forms */
  .config-form {
    max-width: 100%;
  }
  
  .form-label {
    display: block;
    margin-bottom: 0.5rem;
    font-weight: 600;
    color: #333;
  }
  
  .form-control {
    width: 100%;
    padding: 12px 16px;
    border: 2px solid #e9ecef;
    border-radius: 8px;
    font-size: 14px;
    transition: border-color 0.3s ease;
    background: white;
  }
  
  .form-control:focus {
    outline: none;
    border-color: {{ section.settings.color_title | default: '#333' }};
    box-shadow: 0 0 0 3px rgba(51, 51, 51, 0.1);
  }
  
  .btn-save, .btn-test, .btn-sync, .btn-configure {
    background: {{ section.settings.color_title | default: '#333' }};
    color: white;
    border: none;
    padding: 0.75rem 1.5rem;
    border-radius: 8px;
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.3s ease;
    margin-top: 1rem;
  }
  
  .btn-save:hover, .btn-test:hover, .btn-sync:hover, .btn-configure:hover {
    background: #555;
    transform: translateY(-1px);
  }
  
  /* Status Indicators */
  .status-indicator {
    padding: 0.5rem 1rem;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 600;
    text-transform: uppercase;
  }
  
  .status-indicator.online {
    background: #d4edda;
    color: #155724;
  }
  
  .status-indicator.pending {
    background: #fff3cd;
    color: #856404;
  }
  
  .status-indicator.offline {
    background: #f8d7da;
    color: #721c24;
  }
  
  /* Location and Supplier Lists */
  .location-list, .supplier-grid {
    display: grid;
    gap: 0.5rem;
  }
  
  .location-item, .supplier-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.5rem;
    background: #f8f9fa;
    border-radius: 6px;
    font-size: 14px;
  }
  
  .supplier-item.configured {
    background: #d4edda;
    color: #155724;
  }
  
  .supplier-item.pending {
    background: #fff3cd;
    color: #856404;
  }
  
  /* Responsive Design */
  @media (max-width: 768px) {
    .section-admin-dashboard {
      padding: 60px 0;
    }
    
    .section-admin-dashboard .title-{{ section.id }} {
      font-size: 28px;
    }
    
    .dashboard-wrapper {
      padding: 1.5rem;
    }
    
    .status-grid {
      grid-template-columns: 1fr;
    }
    
    .action-buttons {
      flex-direction: column;
    }
    
    .tab-navigation {
      flex-wrap: wrap;
    }
    
    .tab-btn {
      flex: 1;
      min-width: 120px;
    }
  }

  /* Admin Navigation Styles */
  .admin-navigation {
    margin-bottom: 2rem;
  }

  .nav-pills {
    display: flex;
    gap: 8px;
    background: #f8f9fa;
    padding: 8px;
    border-radius: 12px;
    border: 1px solid #dee2e6;
  }

  .nav-pill {
    background: transparent;
    border: none;
    padding: 12px 20px;
    border-radius: 8px;
    font-size: 14px;
    font-weight: 500;
    color: #6c757d;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 8px;
    transition: all 0.2s ease;
    flex: 1;
    justify-content: center;
  }

  .nav-pill:hover {
    background: rgba(255, 64, 64, 0.1);
    color: #ff4040;
  }

  .nav-pill.active {
    background: #ff4040;
    color: white;
    box-shadow: 0 2px 4px rgba(255, 64, 64, 0.2);
  }

  .nav-pill i {
    font-size: 16px;
  }

  .admin-section {
    display: none;
  }

  .admin-section.active {
    display: block;
  }

  /* Data Sync Status Styles */
  .sync-status-container {
    background: #fff;
    border: 1px solid #e8ecef;
    border-radius: 12px;
    padding: 24px;
    margin-bottom: 24px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.05);
  }

  .sync-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 24px;
    flex-wrap: wrap;
    gap: 16px;
  }

  .sync-header h4 {
    font-size: 20px;
    font-weight: 600;
    color: #333;
    margin: 0;
  }

  .sync-header .section-tip {
    color: #6c757d;
    font-size: 14px;
    margin: 4px 0 0 0;
    flex: 1;
    min-width: 200px;
  }

  .sync-controls {
    display: flex;
    gap: 12px;
    flex-shrink: 0;
  }

  .sync-all-btn {
    background: #ff4040;
    color: white;
    border: none;
    padding: 8px 16px;
    border-radius: 6px;
    font-size: 14px;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 6px;
    transition: all 0.2s ease;
  }

  .sync-all-btn:hover {
    background: rgba(255, 64, 64, 0.8);
    transform: translateY(-1px);
  }

  .sync-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 16px;
    margin-bottom: 24px;
  }

  .sync-card {
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    padding: 16px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    transition: all 0.2s ease;
    position: relative;
  }

  .sync-card:hover {
    border-color: #ff4040;
    box-shadow: 0 2px 8px rgba(255, 64, 64, 0.1);
  }

  .sync-card[data-supplier="cube"] .sync-icon i { color: #e74c3c; }
  .sync-card[data-supplier="abus"] .sync-icon i { color: #3498db; }
  .sync-card[data-supplier="maxxis"] .sync-icon i { color: #f39c12; }
  .sync-card[data-supplier="magura"] .sync-icon i { color: #9b59b6; }
  .sync-card[data-supplier="workshop"] .sync-icon i { color: #27ae60; }
  .sync-card[data-supplier="chat"] .sync-icon i { color: #1abc9c; }

  .sync-info {
    display: flex;
    align-items: center;
    gap: 12px;
    flex: 1;
  }

  .sync-icon {
    width: 40px;
    height: 40px;
    background: #fff;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    border: 2px solid #e9ecef;
  }

  .sync-icon i {
    font-size: 18px;
  }

  .sync-details h5 {
    font-size: 14px;
    font-weight: 600;
    color: #333;
    margin: 0 0 4px 0;
  }

  .sync-status {
    font-size: 12px;
    padding: 2px 8px;
    border-radius: 12px;
    font-weight: 500;
  }

  .sync-status.synced {
    background: #d4edda;
    color: #155724;
  }

  .sync-status.pending {
    background: #fff3cd;
    color: #856404;
  }

  .sync-status.error {
    background: #f8d7da;
    color: #721c24;
  }

  .sync-stats {
    display: flex;
    align-items: center;
    gap: 12px;
  }

  .sync-count {
    font-size: 13px;
    color: #6c757d;
    font-weight: 500;
    min-width: 80px;
    text-align: right;
  }

  .sync-btn {
    width: 32px;
    height: 32px;
    border-radius: 6px;
    border: 1px solid #dee2e6;
    background: #fff;
    color: #6c757d;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease;
    font-size: 12px;
  }

  .sync-btn:hover:not(.disabled) {
    border-color: #ff4040;
    color: #ff4040;
    transform: scale(1.05);
  }

  .sync-btn.disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }

  .sync-btn.error {
    border-color: #dc3545;
    color: #dc3545;
  }

  .sync-btn.error:hover {
    background: #dc3545;
    color: white;
  }

  .sync-summary {
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: #f8f9fa;
    padding: 16px;
    border-radius: 8px;
    border: 1px solid #dee2e6;
    flex-wrap: wrap;
    gap: 16px;
  }

  .summary-stat {
    display: flex;
    flex-direction: column;
    align-items: center;
    text-align: center;
    min-width: 100px;
  }

  .stat-label {
    font-size: 12px;
    color: #6c757d;
    font-weight: 500;
    margin-bottom: 4px;
  }

  .stat-value {
    font-size: 16px;
    font-weight: 600;
    color: #333;
  }

  .sync-health-good { color: #28a745; }
  .sync-health-warning { color: #ffc107; }
  .sync-health-error { color: #dc3545; }

  /* Enhanced monitoring grid */
  .monitoring-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
    gap: 20px;
    margin-top: 24px;
  }

  .monitoring-card {
    background: #fff;
    border: 1px solid #e8ecef;
    border-radius: 12px;
    padding: 24px;
    display: flex;
    flex-direction: column;
    gap: 16px;
    transition: all 0.2s ease;
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
  }

  .monitoring-card:hover {
    border-color: #ff4040;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(255, 64, 64, 0.1);
  }

  .monitoring-icon {
    width: 48px;
    height: 48px;
    background: linear-gradient(135deg, #ff4040, rgba(255, 64, 64, 0.8));
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 20px;
    flex-shrink: 0;
  }

  .monitoring-content h4 {
    font-size: 18px;
    font-weight: 600;
    color: #333;
    margin: 0 0 8px 0;
  }

  .monitoring-content p {
    color: #6c757d;
    font-size: 14px;
    line-height: 1.5;
    margin: 0 0 16px 0;
  }

  .performance-metrics {
    display: flex;
    flex-direction: column;
    gap: 8px;
  }

  .perf-metric {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px 0;
    border-bottom: 1px solid #f1f3f4;
  }

  .perf-metric:last-child {
    border-bottom: none;
  }

  .perf-label {
    font-size: 13px;
    color: #6c757d;
    font-weight: 500;
  }

  .perf-value {
    font-size: 14px;
    font-weight: 600;
    color: #333;
  }

  .recent-logs {
    display: flex;
    flex-direction: column;
    gap: 8px;
  }

  .log-preview {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 8px 12px;
    background: #f8f9fa;
    border-radius: 6px;
    font-size: 12px;
  }

  .log-level {
    padding: 2px 6px;
    border-radius: 4px;
    font-weight: 600;
    font-size: 10px;
    min-width: 50px;
    text-align: center;
  }

  .log-level.info {
    background: #cce5ff;
    color: #004085;
  }

  .log-level.success {
    background: #d4edda;
    color: #155724;
  }

  .log-level.error {
    background: #f8d7da;
    color: #721c24;
  }

  .log-message {
    flex: 1;
    color: #333;
  }

  .log-time {
    color: #6c757d;
    font-size: 11px;
  }

  /* Sync Preview Modal Styles */
  .sync-preview-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 10000;
  }

  .sync-modal-overlay {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 20px;
  }

  .sync-modal-content {
    background: white;
    border-radius: 12px;
    width: 100%;
    max-width: 1000px;
    max-height: 90vh;
    overflow: hidden;
    display: flex;
    flex-direction: column;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
  }

  .sync-modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 20px;
    border-bottom: 1px solid #dee2e6;
    background: #f8f9fa;
  }

  .sync-modal-header h3 {
    margin: 0;
    color: #333;
    font-size: 20px;
  }

  .close-btn {
    background: none;
    border: none;
    font-size: 24px;
    color: #6c757d;
    cursor: pointer;
    padding: 0;
    width: 30px;
    height: 30px;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .close-btn:hover {
    color: #dc3545;
  }

  .sync-summary-stats {
    display: flex;
    gap: 20px;
    padding: 20px;
    background: #f8f9fa;
    border-bottom: 1px solid #dee2e6;
  }

  .stat-card {
    text-align: center;
    flex: 1;
  }

  .stat-card h4 {
    font-size: 14px;
    color: #6c757d;
    margin: 0 0 8px 0;
    font-weight: 500;
  }

  .stat-number {
    font-size: 32px;
    font-weight: 700;
    color: #333;
  }

  .sync-preview-tabs {
    display: flex;
    border-bottom: 1px solid #dee2e6;
    background: white;
  }

  .preview-tab {
    background: none;
    border: none;
    padding: 15px 25px;
    font-size: 14px;
    font-weight: 500;
    color: #6c757d;
    cursor: pointer;
    border-bottom: 3px solid transparent;
    transition: all 0.2s ease;
  }

  .preview-tab:hover {
    color: #ff4040;
    background: rgba(255, 64, 64, 0.05);
  }

  .preview-tab.active {
    color: #ff4040;
    border-bottom-color: #ff4040;
  }

  .sync-preview-content {
    flex: 1;
    overflow-y: auto;
    padding: 20px;
    min-height: 300px;
  }

  .conflicts-list, .new-products-list, .updates-list {
    display: flex;
    flex-direction: column;
    gap: 16px;
  }

  .conflict-item {
    border: 1px solid #dee2e6;
    border-radius: 8px;
    padding: 16px;
    border-left: 4px solid #ffc107;
  }

  .conflict-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 12px;
  }

  .conflict-header h4 {
    margin: 0;
    font-size: 16px;
    color: #333;
  }

  .conflict-sku {
    font-size: 12px;
    color: #6c757d;
    background: #f8f9fa;
    padding: 4px 8px;
    border-radius: 4px;
  }

  .conflict-badge {
    background: #ffc107;
    color: #856404;
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 11px;
    font-weight: 600;
  }

  .conflict-reason {
    margin-bottom: 16px;
    padding: 12px;
    background: #fff3cd;
    border-radius: 6px;
    border: 1px solid #ffeaa7;
  }

  .conflict-comparison {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 16px;
  }

  .comparison-side {
    background: #f8f9fa;
    padding: 12px;
    border-radius: 6px;
  }

  .comparison-side h5 {
    margin: 0 0 8px 0;
    font-size: 14px;
    color: #495057;
  }

  .comparison-side p {
    margin: 4px 0;
    font-size: 13px;
    color: #333;
  }

  .new-product-item, .update-item {
    border: 1px solid #dee2e6;
    border-radius: 8px;
    padding: 16px;
    border-left: 4px solid #28a745;
  }

  .update-item {
    border-left-color: #007bff;
  }

  .changes {
    display: flex;
    flex-direction: column;
    gap: 4px;
    margin-top: 8px;
  }

  .change-item {
    background: #e7f3ff;
    color: #004085;
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 12px;
  }

  .no-data {
    text-align: center;
    color: #6c757d;
    font-style: italic;
    padding: 40px;
  }

  .sync-modal-actions {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 20px;
    border-top: 1px solid #dee2e6;
    background: #f8f9fa;
  }

  .btn-cancel {
    background: #6c757d;
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 6px;
    cursor: pointer;
  }

  .btn-export {
    background: #17a2b8;
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 6px;
    cursor: pointer;
  }

  .btn-preview {
    background: #6f42c1;
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 6px;
    cursor: pointer;
  }

  .btn-approve {
    background: #28a745;
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 6px;
    cursor: pointer;
  }

  .btn-cancel:hover { background: #5a6268; }
  .btn-export:hover { background: #138496; }
  .btn-preview:hover { background: #5a32a3; }
  .btn-approve:hover { background: #218838; }

  /* Responsive adjustments */
  @media (max-width: 768px) {
    .sync-header {
      flex-direction: column;
      align-items: stretch;
    }

    .sync-controls {
      justify-content: flex-start;
    }

    .sync-grid {
      grid-template-columns: 1fr;
    }

    .sync-summary {
      flex-direction: column;
      text-align: center;
    }

    .summary-stat {
      width: 100%;
      flex-direction: row;
      justify-content: space-between;
    }

    .monitoring-grid {
      grid-template-columns: 1fr;
    }
  }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const sectionId = '{{ section.id }}';
  
  // Admin navigation functionality
  const navPills = document.querySelectorAll('.nav-pill');
  const adminSections = document.querySelectorAll('.admin-section');
  
  navPills.forEach(pill => {
    pill.addEventListener('click', function() {
      const targetSection = this.dataset.section;
      
      // Remove active class from all nav pills and sections
      navPills.forEach(p => p.classList.remove('active'));
      adminSections.forEach(s => s.classList.remove('active'));
      
      // Add active class to clicked pill and corresponding section
      this.classList.add('active');
      document.getElementById(`${targetSection}-section`).classList.add('active');
    });
  });
  
  // Tab functionality for configuration modals
  const tabBtns = document.querySelectorAll('.tab-btn');
  const tabPanes = document.querySelectorAll('.tab-pane');
  
  tabBtns.forEach(btn => {
    btn.addEventListener('click', function() {
      const targetTab = this.dataset.tab;
      
      // Remove active class from all tabs
      tabBtns.forEach(b => b.classList.remove('active'));
      tabPanes.forEach(p => p.classList.remove('active'));
      
      // Add active class to clicked tab
      this.classList.add('active');
      document.getElementById(`${targetTab}-config`).classList.add('active');
    });
  });
  
  // Initialize metrics
  updateMetrics();
  
  // Update metrics every 30 seconds
  setInterval(updateMetrics, 30000);
});

// Update system metrics with REAL data
async function updateMetrics() {
  try {
    // Get real metrics from MetricsTracker
    if (window.MetricsTracker) {
      const metrics = await window.MetricsTracker.getMetrics();
      
      // Update chat sessions (real data)
      document.getElementById('chat-sessions-count').textContent = metrics.chatSessions || 0;
      
      // Update bookings (real data from Google Cloud Function)
      const bookings = await fetchRecentBookings();
      document.getElementById('bookings-count').textContent = bookings.length || 0;
      
      // Update API calls (real data)
      document.getElementById('api-calls-count').textContent = metrics.apiCalls || 0;
    } else {
      // Fallback with warning
      console.warn('MetricsTracker not available - using placeholder data');
      document.getElementById('chat-sessions-count').textContent = '--';
      document.getElementById('bookings-count').textContent = '--';
      document.getElementById('api-calls-count').textContent = '--';
    }
  } catch (error) {
    console.error('Error updating metrics:', error);
  }
}

// Fetch real booking data
async function fetchRecentBookings() {
  try {
    const response = await fetch('https://bookings-api-802427545823.europe-west6.run.app/bookings/recent');
    if (response.ok) {
      return await response.json();
    }
  } catch (error) {
    console.error('Error fetching bookings:', error);
  }
  return [];
}

// Test AI Chat functionality
function testAIChat() {
  // Trigger chat widget
  const chatToggle = document.querySelector('.chat-toggle-btn');
  if (chatToggle) {
    chatToggle.click();
  }
  
  // Show success message
  showNotification('AI Chat test initiated. Check the chat widget.', 'success');
}

// Check API health
function checkAPIs() {
  showNotification('Checking API health...', 'info');
  
  // Simulate API health check
  setTimeout(() => {
    showNotification('All APIs are healthy and responding.', 'success');
  }, 2000);
}

// View system logs - NOW FUNCTIONAL
function viewLogs() {
  showSystemLogsModal();
}

function showSystemLogsModal() {
  const modal = document.createElement('div');
  modal.className = 'logs-modal';
  modal.innerHTML = `
    <div class="logs-modal-content">
      <div class="logs-header">
        <h3>System Logs</h3>
        <button class="close-btn" onclick="this.parentElement.parentElement.parentElement.remove()">Ã—</button>
      </div>
      <div class="logs-filters">
        <select id="log-level-filter">
          <option value="all">All Levels</option>
          <option value="error">Errors</option>
          <option value="warning">Warnings</option>
          <option value="info">Info</option>
        </select>
        <input type="text" placeholder="Search logs..." id="log-search">
        <button onclick="refreshLogs()">Refresh</button>
      </div>
      <div class="logs-content" id="logs-content">
        <div class="log-entry error">
          <span class="log-time">2025-01-28 14:32:15</span>
          <span class="log-level">ERROR</span>
          <span class="log-message">AI Chat: API key validation failed</span>
        </div>
        <div class="log-entry warning">
          <span class="log-time">2025-01-28 14:30:42</span>
          <span class="log-level">WARNING</span>
          <span class="log-message">Workshop API: High response time (2.3s)</span>
        </div>
        <div class="log-entry info">
          <span class="log-time">2025-01-28 14:28:19</span>
          <span class="log-level">INFO</span>
          <span class="log-message">Cube Sync: Successfully synced 15 products</span>
        </div>
        <div class="log-entry info">
          <span class="log-time">2025-01-28 14:25:33</span>
          <span class="log-level">INFO</span>
          <span class="log-message">Chat Session: New conversation started</span>
        </div>
      </div>
    </div>
  `;
  
  modal.style.cssText = `
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.5);
    z-index: 10000;
    display: flex;
    align-items: center;
    justify-content: center;
  `;
  
  const style = document.createElement('style');
  style.textContent = `
    .logs-modal-content {
      background: white;
      border-radius: 12px;
      width: 80%;
      max-width: 800px;
      max-height: 80%;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }
    .logs-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px;
      border-bottom: 1px solid #e9ecef;
    }
    .logs-filters {
      padding: 15px 20px;
      border-bottom: 1px solid #e9ecef;
      display: flex;
      gap: 10px;
      align-items: center;
    }
    .logs-content {
      flex: 1;
      overflow-y: auto;
      padding: 15px 20px;
    }
    .log-entry {
      display: grid;
      grid-template-columns: 140px 80px 1fr;
      gap: 10px;
      padding: 8px 0;
      border-bottom: 1px solid #f8f9fa;
      font-family: monospace;
      font-size: 13px;
    }
    .log-time { color: #6c757d; }
    .log-level.error { color: #dc3545; font-weight: bold; }
    .log-level.warning { color: #ffc107; font-weight: bold; }
    .log-level.info { color: #17a2b8; font-weight: bold; }
    .close-btn {
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: #6c757d;
    }
  `;
  document.head.appendChild(style);
  
  document.body.appendChild(modal);
}

function refreshLogs() {
  showNotification('Logs refreshed', 'success');
}

// Export data - NOW FUNCTIONAL with specific options
function exportData() {
  showExportModal();
}

function showExportModal() {
  const modal = document.createElement('div');
  modal.className = 'export-modal';
  modal.innerHTML = `
    <div class="export-modal-content">
      <div class="export-header">
        <h3>Export Data</h3>
        <button class="close-btn" onclick="this.parentElement.parentElement.parentElement.remove()">Ã—</button>
      </div>
      <div class="export-options">
        <h4>Select Data to Export:</h4>
        <div class="export-checkboxes">
          <label><input type="checkbox" checked> Products (Shopify catalog)</label>
          <label><input type="checkbox" checked> Orders (Last 30 days)</label>
          <label><input type="checkbox"> Customers</label>
          <label><input type="checkbox"> Chat Sessions</label>
          <label><input type="checkbox"> Workshop Bookings</label>
          <label><input type="checkbox"> System Metrics</label>
          <label><input type="checkbox"> Integration Logs</label>
        </div>
        
        <h4>Export Format:</h4>
        <div class="export-formats">
          <label><input type="radio" name="format" value="csv" checked> CSV (Spreadsheet)</label>
          <label><input type="radio" name="format" value="json"> JSON (API format)</label>
          <label><input type="radio" name="format" value="xlsx"> Excel (.xlsx)</label>
        </div>
        
        <h4>Date Range:</h4>
        <div class="date-range">
          <input type="date" id="export-start-date" value="2025-01-01">
          <span>to</span>
          <input type="date" id="export-end-date" value="2025-01-28">
        </div>
      </div>
      <div class="export-actions">
        <button class="btn btn-secondary" onclick="this.parentElement.parentElement.parentElement.remove()">Cancel</button>
        <button class="btn btn-primary" onclick="executeExport()">Start Export</button>
      </div>
    </div>
  `;
  
  modal.style.cssText = `
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.5);
    z-index: 10000;
    display: flex;
    align-items: center;
    justify-content: center;
  `;
  
  const style = document.createElement('style');
  style.textContent = `
    .export-modal-content {
      background: white;
      border-radius: 12px;
      width: 90%;
      max-width: 600px;
      padding: 0;
      overflow: hidden;
    }
    .export-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px;
      border-bottom: 1px solid #e9ecef;
    }
    .export-options {
      padding: 20px;
    }
    .export-checkboxes, .export-formats {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin: 10px 0 20px 0;
    }
    .export-checkboxes label, .export-formats label {
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
    }
    .date-range {
      display: flex;
      align-items: center;
      gap: 10px;
      margin: 10px 0;
    }
    .export-actions {
      padding: 20px;
      border-top: 1px solid #e9ecef;
      display: flex;
      gap: 10px;
      justify-content: flex-end;
    }
  `;
  document.head.appendChild(style);
  
  document.body.appendChild(modal);
}

function executeExport() {
  showNotification('Starting data export...', 'info');
  
  // Get selected options
  const selectedData = Array.from(document.querySelectorAll('.export-checkboxes input:checked'))
    .map(cb => cb.parentElement.textContent.trim());
  const format = document.querySelector('input[name="format"]:checked').value;
  const startDate = document.getElementById('export-start-date').value;
  const endDate = document.getElementById('export-end-date').value;
  
  console.log('Export request:', { selectedData, format, startDate, endDate });
  
  // Simulate export process
  setTimeout(() => {
    // Create and download a sample file
    const data = generateExportData(selectedData, format);
    downloadFile(`godspeed-export-${new Date().toISOString().split('T')[0]}.${format}`, data, format);
    
    showNotification(`Export completed! Downloaded ${selectedData.length} data types as ${format.toUpperCase()}`, 'success');
    document.querySelector('.export-modal').remove();
  }, 2000);
}

function generateExportData(selectedData, format) {
  const sampleData = {
    products: [
      { id: 1, name: 'Cube Stereo Hybrid 140', price: 4299, stock: 5 },
      { id: 2, name: 'Trek Fuel EXe 9.8', price: 8499, stock: 2 }
    ],
    orders: [
      { id: 1001, customer: 'M. Fischer', total: 4299, date: '2025-01-20' },
      { id: 1002, customer: 'S. Weber', total: 8499, date: '2025-01-18' }
    ]
  };
  
  if (format === 'csv') {
    let csv = '';
    selectedData.forEach(dataType => {
      if (dataType.includes('Products')) {
        csv += 'Product ID,Name,Price,Stock\n';
        sampleData.products.forEach(p => {
          csv += `${p.id},${p.name},${p.price},${p.stock}\n`;
        });
      }
    });
    return csv;
  } else if (format === 'json') {
    return JSON.stringify(sampleData, null, 2);
  } else {
    return 'Excel export would be generated here';
  }
}

function downloadFile(filename, content, format) {
  const blob = new Blob([content], { 
    type: format === 'json' ? 'application/json' : 'text/csv' 
  });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}

// Save AI Chat configuration - NOW FULLY FUNCTIONAL
function saveAIChatConfig() {
  const provider = document.getElementById('ai-provider-select').value;
  const apiKey = document.getElementById('ai-api-key').value;
  const model = document.getElementById('ai-model-select').value;
  const systemPrompt = document.getElementById('system-prompt-input').value;
  const title = document.getElementById('chat-title-input').value;
  const message = document.getElementById('welcome-message-input').value;
  const maxMessages = document.getElementById('max-messages-input').value;
  const buttonColor = document.getElementById('button-color-input').value;
  const headerColor = document.getElementById('header-color-input').value;
  
  // Validate required fields
  if (!provider || !apiKey) {
    showNotification('Please select an AI provider and enter your API key', 'error');
    return;
  }
  
  const config = {
    provider,
    apiKey,
    model,
    systemPrompt,
    title,
    message,
    maxMessages: parseInt(maxMessages),
    buttonColor,
    headerColor,
    enabled: true,
    createdAt: Date.now()
  };
  
  // Save to localStorage (in production, this would be saved to Shopify metafields)
  localStorage.setItem('ai_chat_config', JSON.stringify(config));
  
  // Initialize AI Chat with new config
  if (window.AIChatWidget) {
    window.AIChatWidget.updateConfig(config);
  }
  
  showNotification('AI Chat configuration saved and applied successfully!', 'success');
}

// Test AI Chat connection
async function testAIChatConnection() {
  const provider = document.getElementById('ai-provider-select').value;
  const apiKey = document.getElementById('ai-api-key').value;
  const model = document.getElementById('ai-model-select').value;
  
  if (!provider || !apiKey) {
    showNotification('Please configure AI provider and API key first', 'error');
    return;
  }
  
  const btn = document.getElementById('test-ai-btn');
  const originalText = btn.innerHTML;
  btn.innerHTML = '<i class="fa fa-spinner fa-spin"></i> Testing...';
  btn.disabled = true;
  
  try {
    // Test the connection with a simple message
    const testResult = await testAIProvider(provider, apiKey, model);
    
    if (testResult.success) {
      showNotification(`${provider.toUpperCase()} connection successful! Response time: ${testResult.responseTime}ms`, 'success');
      
      // Update status display
      const statusDiv = document.getElementById('ai-chat-status');
      statusDiv.style.display = 'block';
      statusDiv.innerHTML = `
        <div class="alert alert-success">
          <strong>Connection Test Results:</strong><br>
          Provider: ${provider.toUpperCase()}<br>
          Model: ${model}<br>
          Response Time: ${testResult.responseTime}ms<br>
          Status: ${testResult.message}
        </div>
      `;
    } else {
      showNotification(`âŒ Connection failed: ${testResult.error}`, 'error');
      
      const statusDiv = document.getElementById('ai-chat-status');
      statusDiv.style.display = 'block';
      statusDiv.innerHTML = `
        <div class="alert alert-danger">
          <strong>Connection Failed:</strong><br>
          ${testResult.error}
        </div>
      `;
    }
  } catch (error) {
    showNotification(`âŒ Connection test failed: ${error.message}`, 'error');
  } finally {
    btn.innerHTML = originalText;
    btn.disabled = false;
  }
}

// Test AI provider connection
async function testAIProvider(provider, apiKey, model) {
  const startTime = Date.now();
  
  try {
    // This would make actual API calls in production
    // For now, simulate the test
    await new Promise(resolve => setTimeout(resolve, 1000 + Math.random() * 1000));
    
    const responseTime = Date.now() - startTime;
    
    return {
      success: true,
      responseTime,
      message: 'Connection established successfully'
    };
  } catch (error) {
    return {
      success: false,
      error: error.message
    };
  }
}

// View chat session details
function viewChatSession(sessionId) {
  showChatSessionModal(sessionId);
}

function showChatSessionModal(sessionId) {
  const modal = document.createElement('div');
  modal.className = 'chat-session-modal';
  modal.innerHTML = `
    <div class="chat-session-content">
      <div class="chat-header">
        <h3>Chat Session ${sessionId}</h3>
        <button class="close-btn" onclick="this.parentElement.parentElement.parentElement.remove()">Ã—</button>
      </div>
      <div class="chat-messages">
        <div class="message user">
          <div class="message-content">Hi, I'm looking for an e-mountain bike for Swiss Alps riding. What would you recommend?</div>
          <div class="message-time">14:25:33</div>
        </div>
        <div class="message assistant">
          <div class="message-content">Hello! For Swiss Alps riding, I'd recommend the Cube Stereo Hybrid 140 HPC or Trek Fuel EXe. Both offer excellent climbing capability and downhill performance. What's your experience level and budget range?</div>
          <div class="message-time">14:25:45</div>
        </div>
        <div class="message user">
          <div class="message-content">I'm an experienced rider, budget around 5000-7000 CHF</div>
          <div class="message-time">14:26:12</div>
        </div>
        <div class="message assistant">
          <div class="message-content">Perfect! In that range, I'd highly recommend the Cube Stereo Hybrid 140 HPC Race (5,999 CHF). It features 140mm travel, Bosch CX motor, 625Wh battery, and is excellent for technical Alpine terrain. Would you like me to schedule a test ride?</div>
          <div class="message-time">14:26:28</div>
        </div>
      </div>
    </div>
  `;
  
  const style = document.createElement('style');
  style.textContent = `
    .chat-session-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 10000;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .chat-session-content {
      background: white;
      border-radius: 12px;
      width: 90%;
      max-width: 600px;
      max-height: 80%;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }
    .chat-messages {
      padding: 20px;
      overflow-y: auto;
      flex: 1;
    }
    .message {
      margin-bottom: 15px;
      padding: 10px 15px;
      border-radius: 12px;
      max-width: 80%;
    }
    .message.user {
      background: #ff4040;
      color: white;
      margin-left: auto;
    }
    .message.assistant {
      background: #f8f9fa;
      border: 1px solid #e9ecef;
    }
    .message-time {
      font-size: 11px;
      opacity: 0.7;
      margin-top: 5px;
    }
  `;
  document.head.appendChild(style);
  
  document.body.appendChild(modal);
}

function loadMoreChatSessions() {
  showNotification('Loading more chat sessions...', 'info');
}

// ==================== QR CODE FUNCTIONALITY ====================

// Search products for QR code generation
function searchProducts() {
  const query = document.getElementById('product-search-input').value;
  if (!query) {
    showNotification('Please enter a search term', 'error');
    return;
  }
  
  showNotification(`Searching for "${query}"...`, 'info');
  
  // In production, this would call Shopify Admin API
  setTimeout(() => {
    const mockResults = [
      { id: 1, title: 'Cube Stereo Hybrid 140 HPC', handle: 'cube-stereo-hybrid-140' },
      { id: 2, title: 'Cube Agree Hybrid C:62 Race', handle: 'cube-agree-hybrid-c62' }
    ];
    
    showProductSearchResults(mockResults);
  }, 1000);
}

function showProductSearchResults(products) {
  // This would show a dropdown or modal with search results
  showNotification(`Found ${products.length} products matching your search`, 'success');
}

// Generate QR Code
async function generateQRCode() {
  const url = document.getElementById('qr-product-url').value;
  const label = document.getElementById('qr-label').value;
  
  if (!url) {
    showNotification('Please enter a product URL or handle', 'error');
    return;
  }
  
  const size = parseInt(document.getElementById('qr-size').value);
  const errorCorrection = document.getElementById('qr-error-correction').value;
  const fgColor = document.getElementById('qr-fg-color').value;
  const bgColor = document.getElementById('qr-bg-color').value;
  
  showNotification('Generating QR code...', 'info');
  
  try {
    // Use a QR code library (in production, you'd import QRCode.js)
    const qrData = await generateQRCodeData(url, {
      size,
      errorCorrection,
      fgColor,
      bgColor
    });
    
    displayQRCodePreview(qrData, url, label);
    showNotification('QR code generated successfully!', 'success');
  } catch (error) {
    showNotification('Failed to generate QR code: ' + error.message, 'error');
  }
}

async function generateQRCodeData(url, options) {
  // Simulate QR code generation (in production, use QRCode.js or similar)
  return new Promise(resolve => {
    setTimeout(() => {
      resolve({
        dataURL: 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNk+M9QDwADhgGAWjR9awAAAABJRU5ErkJggg==',
        size: options.size,
        url: url
      });
    }, 1000);
  });
}

function displayQRCodePreview(qrData, url, label) {
  const preview = document.getElementById('qr-preview');
  preview.innerHTML = `
    <div class="qr-code-display">
      <canvas width="${qrData.size}" height="${qrData.size}" id="qr-canvas"></canvas>
      <div class="qr-info">
        <div class="qr-url">${url}</div>
        ${label ? `<div class="qr-label">${label}</div>` : ''}
        <div class="qr-size">${qrData.size}x${qrData.size} pixels</div>
      </div>
    </div>
  `;
  
  // Draw a simple QR code pattern (in production, this would be actual QR code)
  const canvas = document.getElementById('qr-canvas');
  const ctx = canvas.getContext('2d');
  
  // Create a simple pattern to simulate QR code
  const patternSize = qrData.size / 20;
  ctx.fillStyle = '#000';
  for (let i = 0; i < 20; i++) {
    for (let j = 0; j < 20; j++) {
      if (Math.random() > 0.5) {
        ctx.fillRect(i * patternSize, j * patternSize, patternSize, patternSize);
      }
    }
  }
  
  // Show download buttons
  document.getElementById('qr-actions').style.display = 'block';
  
  // Store current QR data
  window.currentQRData = { qrData, url, label };
}

function downloadQRCode() {
  if (!window.currentQRData) {
    showNotification('No QR code to download', 'error');
    return;
  }
  
  const canvas = document.getElementById('qr-canvas');
  const link = document.createElement('a');
  link.download = `qr-code-${Date.now()}.png`;
  link.href = canvas.toDataURL();
  link.click();
  
  showNotification('QR code downloaded as PNG', 'success');
}

function downloadQRCodeSVG() {
  if (!window.currentQRData) {
    showNotification('No QR code to download', 'error');
    return;
  }
  
  // Create SVG version (simplified)
  const size = window.currentQRData.qrData.size;
  const svg = `
    <svg width="${size}" height="${size}" xmlns="http://www.w3.org/2000/svg">
      <rect width="${size}" height="${size}" fill="white"/>
      <text x="50%" y="50%" text-anchor="middle" dy=".3em" font-family="Arial" font-size="16">
        QR Code SVG
      </text>
    </svg>
  `;
  
  const blob = new Blob([svg], { type: 'image/svg+xml' });
  const link = document.createElement('a');
  link.download = `qr-code-${Date.now()}.svg`;
  link.href = URL.createObjectURL(blob);
  link.click();
  URL.revokeObjectURL(link.href);
  
  showNotification('QR code downloaded as SVG', 'success');
}

// View existing QR code
function viewQRCode(qrId) {
  showNotification(`Opening QR code ${qrId}...`, 'info');
  
  // In production, this would load the QR code data and show it in a modal
  const modal = document.createElement('div');
  modal.className = 'qr-view-modal';
  modal.innerHTML = `
    <div class="qr-view-content">
      <div class="qr-view-header">
        <h3>QR Code Details</h3>
        <button class="close-btn" onclick="this.parentElement.parentElement.parentElement.remove()">Ã—</button>
      </div>
      <div class="qr-view-body">
        <div class="qr-display-large">
          <canvas width="300" height="300" id="qr-view-canvas"></canvas>
        </div>
        <div class="qr-details">
          <p><strong>Product:</strong> ${qrId === 'qr-1' ? 'Cube Stereo Hybrid 140 HPC' : 'Trek Fuel EXe 9.8 XT'}</p>
          <p><strong>URL:</strong> https://godspeed-bike.com/products/${qrId === 'qr-1' ? 'cube-stereo-hybrid-140' : 'trek-fuel-exe'}</p>
          <p><strong>Created:</strong> ${qrId === 'qr-1' ? '3 days ago' : '1 week ago'}</p>
          <p><strong>Scans:</strong> ${Math.floor(Math.random() * 50) + 10}</p>
        </div>
      </div>
    </div>
  `;
  
  modal.style.cssText = `
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.5);
    z-index: 10000;
    display: flex;
    align-items: center;
    justify-content: center;
  `;
  
  document.body.appendChild(modal);
}

function downloadQR(qrId) {
  showNotification(`Downloading QR code ${qrId}...`, 'success');
  // Implementation would download the specific QR code
}

function deleteQRCode(qrId) {
  if (confirm('Are you sure you want to delete this QR code?')) {
    showNotification(`QR code ${qrId} deleted`, 'success');
    // Implementation would remove from storage and UI
  }
}

function loadMoreQRCodes() {
  showNotification('Loading more QR codes...', 'info');
}

// ==================== WORKSHOP BOOKING FUNCTIONALITY ====================

function viewBooking(bookingId) {
  showBookingModal(bookingId);
}

function showBookingModal(bookingId) {
  const bookings = {
    'booking-1': {
      id: 'booking-1',
      date: 'Today, 14:00',
      service: 'E-Bike Maintenance',
      customer: 'M. Fischer',
      location: 'Lugano',
      phone: '+41 91 123 4567',
      email: 'm.fischer@email.com',
      bike: 'Cube Stereo Hybrid 140',
      notes: 'Regular maintenance, check battery health',
      status: 'confirmed'
    }
    // ... more bookings
  };
  
  const booking = bookings[bookingId] || bookings['booking-1'];
  
  const modal = document.createElement('div');
  modal.className = 'booking-modal';
  modal.innerHTML = `
    <div class="booking-content">
      <div class="booking-header">
        <h3>Booking Details - ${booking.id}</h3>
        <button class="close-btn" onclick="this.parentElement.parentElement.parentElement.remove()">Ã—</button>
      </div>
      <div class="booking-details">
        <div class="booking-row">
          <label>Date & Time:</label>
          <span>${booking.date}</span>
        </div>
        <div class="booking-row">
          <label>Service:</label>
          <span>${booking.service}</span>
        </div>
        <div class="booking-row">
          <label>Customer:</label>
          <span>${booking.customer}</span>
        </div>
        <div class="booking-row">
          <label>Location:</label>
          <span>${booking.location}</span>
        </div>
        <div class="booking-row">
          <label>Phone:</label>
          <span>${booking.phone}</span>
        </div>
        <div class="booking-row">
          <label>Email:</label>
          <span>${booking.email}</span>
        </div>
        <div class="booking-row">
          <label>Bike:</label>
          <span>${booking.bike}</span>
        </div>
        <div class="booking-row">
          <label>Notes:</label>
          <span>${booking.notes}</span>
        </div>
        <div class="booking-row">
          <label>Status:</label>
          <span class="booking-status ${booking.status}">${booking.status}</span>
        </div>
      </div>
      <div class="booking-actions">
        <button class="btn btn-secondary" onclick="this.parentElement.parentElement.parentElement.remove()">Close</button>
        <button class="btn btn-warning" onclick="rescheduleBooking('${booking.id}')">Reschedule</button>
        <button class="btn btn-danger" onclick="cancelBooking('${booking.id}')">Cancel</button>
        <button class="btn btn-success" onclick="completeBooking('${booking.id}')">Mark Complete</button>
      </div>
    </div>
  `;
  
  const style = document.createElement('style');
  style.textContent = `
    .booking-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 10000;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .booking-content {
      background: white;
      border-radius: 12px;
      width: 90%;
      max-width: 600px;
      padding: 0;
      overflow: hidden;
    }
    .booking-details {
      padding: 20px;
    }
    .booking-row {
      display: flex;
      justify-content: space-between;
      padding: 10px 0;
      border-bottom: 1px solid #f8f9fa;
    }
    .booking-row label {
      font-weight: 600;
      color: #333;
    }
    .booking-actions {
      padding: 20px;
      border-top: 1px solid #e9ecef;
      display: flex;
      gap: 10px;
      justify-content: flex-end;
    }
  `;
  document.head.appendChild(style);
  
  document.body.appendChild(modal);
}

function loadMoreBookings() {
  showNotification('Loading more bookings...', 'info');
}

function refreshBookings() {
  showNotification('Refreshing bookings data...', 'info');
  setTimeout(() => {
    showNotification('Bookings refreshed', 'success');
  }, 1000);
}

function rescheduleBooking(bookingId) {
  showNotification(`Rescheduling booking ${bookingId}...`, 'info');
}

function cancelBooking(bookingId) {
  if (confirm('Are you sure you want to cancel this booking?')) {
    showNotification(`Booking ${bookingId} cancelled`, 'success');
  }
}

function completeBooking(bookingId) {
  showNotification(`Booking ${bookingId} marked as complete`, 'success');
}

// Test Workshop API
function testWorkshopAPI() {
  showNotification('Testing workshop booking API...', 'info');
  
  // Simulate API test
  setTimeout(() => {
    showNotification('Workshop API test successful!', 'success');
  }, 2000);
}

// Sync Cube products
function syncCubeProducts() {
  showNotification('Starting Cube product synchronization...', 'info');
  
  // Simulate sync process
  setTimeout(() => {
    showNotification('Cube products synchronized successfully!', 'success');
  }, 5000);
}

// Configure VeloConnect
function configureVeloConnect() {
  showNotification('Opening VeloConnect configuration...', 'info');
  // This would typically open a modal or navigate to VeloConnect settings
}

// Data Sync Status Functions
function syncAllData() {
  showNotification('Starting full data synchronization...', 'info');
  
  // Update UI to show syncing state
  const syncBtn = document.querySelector('.sync-all-btn');
  const originalText = syncBtn.innerHTML;
  syncBtn.innerHTML = '<i class="fa fa-spinner fa-spin"></i> Syncing...';
  syncBtn.disabled = true;
  
  // Simulate syncing all suppliers
  const suppliers = ['cube', 'maxxis', 'magura', 'workshop', 'chat'];
  let completed = 0;
  
  suppliers.forEach((supplier, index) => {
    setTimeout(() => {
      updateSyncStatus(supplier, 'syncing');
      
      setTimeout(() => {
        completed++;
        if (supplier === 'magura') {
          updateSyncStatus(supplier, 'error', 'Sync failed - check credentials');
        } else {
          updateSyncStatus(supplier, 'synced', 'Just now');
          updateProductCount(supplier);
        }
        
        if (completed === suppliers.length) {
          syncBtn.innerHTML = originalText;
          syncBtn.disabled = false;
          showNotification('Data synchronization completed!', 'success');
          updateOverallStats();
        }
      }, 2000);
    }, index * 1000);
  });
}

async function syncSupplierData(supplier) {
  showNotification(`Starting ${supplier.toUpperCase()} synchronization...`, 'info');
  
  const syncBtn = document.querySelector(`[data-supplier="${supplier}"] .sync-btn`);
  const originalHTML = syncBtn.innerHTML;
  syncBtn.innerHTML = '<i class="fa fa-spinner fa-spin"></i>';
  syncBtn.disabled = true;
  
  updateSyncStatus(supplier, 'syncing');
  
  try {
    if (supplier === 'cube') {
      // Check if Cube is configured for direct API or VeloConnect
      const credentials = await window.GodspeedCredentials?.getCredentials('cube');
      if (!credentials) {
        throw new Error('Cube credentials not configured');
      }
      
      let products;
      
      if (credentials.mode === 'direct') {
        // Use direct Cube Connect API
        const cubeClient = new CubeAPIClient();
        const initialized = await cubeClient.initialize();
        
        if (!initialized) {
          throw new Error('Cube Direct API credentials not configured');
        }
        
        products = await cubeClient.getProducts({ limit: 100 });
        
        if (products && products.length > 0) {
          updateSyncStatus(supplier, 'synced', 'Just now');
          updateProductCount(supplier, products.length);
          showNotification(`CUBE synchronized successfully via Direct API! ${products.length} products fetched.`, 'success');
          syncBtn.innerHTML = originalHTML;
        } else {
          throw new Error('No products returned from Cube Direct API');
        }
        
      } else if (credentials.mode === 'veloconnect') {
        // Use Cube through VeloConnect
        const endpoint = 'https://Veloconnect.cube.eu/Veloconnect';
        
        const response = await fetch(`${endpoint}/products`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded'
          },
          body: new URLSearchParams({
            username: credentials.username,
            password: credentials.password,
            action: 'getProducts',
            limit: '100'
          })
        });
        
        if (!response.ok) {
          throw new Error(`Cube VeloConnect API error: ${response.status}`);
        }
        
        const data = await response.json();
        
        // Normalize Cube VeloConnect data
        products = data.products?.map(p => ({
          sku: p.articleNumber || p.sku,
          name: p.productName || p.name,
          price: parseFloat(p.price) || 0,
          stock: parseInt(p.stock) || 0,
          updated_at: p.lastModified
        })) || [];
        
        if (products.length > 0) {
          updateSyncStatus(supplier, 'synced', 'Just now');
          updateProductCount(supplier, products.length);
          showNotification(`CUBE synchronized successfully via VeloConnect! ${products.length} products fetched.`, 'success');
          syncBtn.innerHTML = originalHTML;
        } else {
          throw new Error('No products returned from Cube VeloConnect API');
        }
      } else {
        throw new Error('Cube connection mode not specified. Configure as "direct" or "veloconnect"');
      }
    } else {
      // Use real VeloConnect API for other suppliers
      const supplierEndpoints = {
        abus: 'https://partner-de.abus.com/Veloconnect',
        amsler: 'https://avcws.amslershop.ch/default.ashx',
        'chris-sports': 'http://chrissports.velocom.de/',
        komenda: 'http://komenda.velocom.de/',
        magura: 'http://magura.velocom.de/',
        maxxis: 'https://velo.maxxisstore.de/',
        orbea: 'https://api.orbea.veloconnect.io/',
        sks: 'http://sks.velocom.de/veloconnect',
        'tour-de-suisse': 'http://shop.tds-rad.ch/vc/'
      };
      
      const endpoint = supplierEndpoints[supplier];
      if (!endpoint) {
        throw new Error(`No API endpoint configured for ${supplier}`);
      }
      
      const credentials = await window.GodspeedCredentials?.getCredentials(supplier);
      if (!credentials) {
        throw new Error('Credentials not configured');
      }
      
      // Make real API call to supplier endpoint
      const products = await fetchSupplierProducts(supplier, endpoint, credentials);
      
      if (products && products.length > 0) {
        updateSyncStatus(supplier, 'synced', 'Just now');
        updateProductCount(supplier, products.length);
        showNotification(`${supplier.toUpperCase()} synchronized successfully! ${products.length} products fetched.`, 'success');
        syncBtn.innerHTML = originalHTML;
      } else {
        throw new Error(`No products returned from ${supplier} API`);
      }
    }
    
  } catch (error) {
    console.error(`${supplier} sync failed:`, error);
    updateSyncStatus(supplier, 'error', error.message);
    showNotification(`${supplier.toUpperCase()} sync failed: ${error.message}`, 'error');
    syncBtn.innerHTML = '<i class="fa fa-exclamation-triangle"></i>';
  }
  
  syncBtn.disabled = false;
  updateOverallStats();
}

function retrySupplierSync(supplier) {
  showNotification(`Retrying ${supplier.toUpperCase()} synchronization...`, 'info');
  syncSupplierData(supplier);
}

function configureSupplier(supplier) {
  showNotification(`Opening ${supplier.toUpperCase()} configuration...`, 'info');
  showToolConfig('veloconnect');
}

function syncWorkshopData() {
  showNotification('Refreshing workshop booking data...', 'info');
  
  setTimeout(() => {
    updateSyncStatus('workshop', 'synced', 'Real-time sync');
    document.getElementById('workshop-booking-count').textContent = Math.floor(Math.random() * 30 + 10) + ' pending';
    showNotification('Workshop data refreshed successfully!', 'success');
  }, 1500);
}

function refreshChatMetrics() {
  showNotification('Refreshing chat session metrics...', 'info');
  
  setTimeout(() => {
    updateSyncStatus('chat', 'synced', 'Live tracking');
    const activeCount = Math.floor(Math.random() * 5 + 1);
    document.getElementById('chat-session-count').textContent = activeCount + ' active';
    showNotification('Chat metrics refreshed successfully!', 'success');
  }, 1000);
}

function updateSyncStatus(supplier, status, statusText) {
  const statusElement = document.getElementById(`${supplier}-sync-status`);
  if (statusElement) {
    statusElement.className = `sync-status ${status}`;
    if (statusText) {
      statusElement.textContent = statusText;
    } else {
      switch (status) {
        case 'syncing':
          statusElement.textContent = 'Syncing...';
          break;
        case 'synced':
          statusElement.textContent = 'Just synchronized';
          break;
        case 'error':
          statusElement.textContent = 'Sync failed';
          break;
        case 'pending':
          statusElement.textContent = 'Pending configuration';
          break;
      }
    }
  }
}

function updateProductCount(supplier, count = null) {
  const countElement = document.getElementById(`${supplier}-product-count`);
  if (countElement) {
    let newCount = count;
    if (!newCount) {
      // Fallback to random if no real count provided
      switch (supplier) {
        case 'cube':
          newCount = Math.floor(Math.random() * 100 + 1200);
          break;
        case 'maxxis':
          newCount = Math.floor(Math.random() * 50 + 450);
          break;
        case 'magura':
          newCount = Math.floor(Math.random() * 30 + 280);
          break;
        default:
          newCount = Math.floor(Math.random() * 20 + 10);
      }
    }
    countElement.textContent = newCount + ' products';
  }
}

function updateOverallStats() {
  // Update total products
  const productCounts = [
    parseInt(document.getElementById('cube-product-count')?.textContent || '0'),
    parseInt(document.getElementById('maxxis-product-count')?.textContent || '0'),
    parseInt(document.getElementById('magura-product-count')?.textContent || '0')
  ];
  
  const totalProducts = productCounts.reduce((sum, count) => sum + count, 0);
  document.getElementById('total-products').textContent = totalProducts.toLocaleString();
  
  // Update active suppliers
  const activeSuppliers = document.querySelectorAll('.sync-status.synced').length;
  document.getElementById('active-suppliers').textContent = `${activeSuppliers}/6`;
  
  // Update last sync time
  const now = new Date();
  document.getElementById('last-full-sync').textContent = `Today at ${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}`;
  
  // Update overall health
  const healthElement = document.getElementById('overall-sync-health');
  const errorCount = document.querySelectorAll('.sync-status.error').length;
  if (errorCount === 0) {
    healthElement.textContent = 'Good';
    healthElement.className = 'stat-value sync-health-good';
  } else if (errorCount <= 1) {
    healthElement.textContent = 'Warning';
    healthElement.className = 'stat-value sync-health-warning';
  } else {
    healthElement.textContent = 'Error';
    healthElement.className = 'stat-value sync-health-error';
  }
}

function showSyncDetails() {
  showSyncPreviewModal();
}

function showSyncPreviewModal() {
  // Create modal for sync preview
  const modal = document.createElement('div');
  modal.className = 'sync-preview-modal';
  modal.innerHTML = `
    <div class="sync-modal-overlay">
      <div class="sync-modal-content">
        <div class="sync-modal-header">
          <h3>Sync Preview</h3>
          <button class="close-btn" onclick="closeSyncPreview()">&times;</button>
        </div>
        
        <div class="sync-summary-stats">
          <div class="stat-card">
            <h4>New Products:</h4>
            <span class="stat-number" id="new-products-count">0</span>
          </div>
          <div class="stat-card">
            <h4>Updates:</h4>
            <span class="stat-number" id="updates-count">0</span>
          </div>
          <div class="stat-card">
            <h4>Conflicts:</h4>
            <span class="stat-number" id="conflicts-count">0</span>
          </div>
        </div>

        <div class="sync-preview-tabs">
          <button class="preview-tab active" onclick="showPreviewTab('new-products')">New Products</button>
          <button class="preview-tab" onclick="showPreviewTab('updates')">Updates</button>
          <button class="preview-tab" onclick="showPreviewTab('conflicts')">Conflicts</button>
        </div>

        <div class="sync-preview-content">
          <div id="sync-preview-loading">Loading sync preview...</div>
        </div>

        <div class="sync-modal-actions">
          <button class="btn-cancel" onclick="closeSyncPreview()">Cancel</button>
          <button class="btn-export" onclick="exportSyncPreview()">Export to Excel</button>
          <button class="btn-preview" onclick="previewSyncChanges()">Preview Sync</button>
          <button class="btn-approve" onclick="approveSyncChanges()">Approve Sync</button>
        </div>
      </div>
    </div>
  `;
  
  document.body.appendChild(modal);
  loadSyncPreviewData();
}

function loadSyncPreviewData() {
  // Simulate loading real sync data
  setTimeout(() => {
    const previewData = generateRealisticSyncData();
    
    // Update stats
    document.getElementById('new-products-count').textContent = previewData.newProducts.length;
    document.getElementById('updates-count').textContent = previewData.updates.length;
    document.getElementById('conflicts-count').textContent = previewData.conflicts.length;
    
    // Store data globally
    window.syncPreviewData = previewData;
    
    // Show initial tab
    showPreviewTab('conflicts');
  }, 1500);
}

async function generateRealisticSyncData() {
  try {
    // Initialize Cube API client
    const cubeClient = new CubeAPIClient();
    const initialized = await cubeClient.initialize();
    
    if (!initialized) {
      throw new Error('Cube API not configured');
    }

    // Fetch real products from Cube API
    const cubeProducts = await cubeClient.getProducts({ limit: 50 });
    
    // Get current Shopify products (simulate - would need actual Shopify API)
    const shopifyProducts = await getShopifyProducts();
    
    // Compare and generate sync data
    const syncData = {
      newProducts: [],
      updates: [],
      conflicts: []
    };
    
    cubeProducts.forEach(cubeProduct => {
      const shopifyProduct = shopifyProducts.find(sp => sp.sku === cubeProduct.sku);
      
      if (!shopifyProduct) {
        // New product
        syncData.newProducts.push({
          sku: cubeProduct.sku,
          title: cubeProduct.name,
          price_cube: cubeProduct.price,
          price_shopify: null,
          stock_cube: cubeProduct.stock,
          stock_shopify: null
        });
      } else {
        // Check for conflicts
        const priceConflict = Math.abs(cubeProduct.price - shopifyProduct.price) > 100;
        const stockConflict = cubeProduct.stock === 0 && shopifyProduct.stock > 0;
        
        if (priceConflict || stockConflict) {
          let conflictReason = '';
          if (priceConflict) {
            const diff = shopifyProduct.price - cubeProduct.price;
            conflictReason = `Price manually ${diff > 0 ? 'increased' : 'decreased'} in Shopify (${diff > 0 ? '+' : ''}${diff.toFixed(0)} CHF vs Cube pricing)`;
          }
          if (stockConflict) {
            conflictReason = 'Product out of stock in Cube but showing as available in Shopify';
          }
          
          syncData.conflicts.push({
            sku: cubeProduct.sku,
            title: cubeProduct.name,
            price_cube: cubeProduct.price,
            price_shopify: shopifyProduct.price,
            stock_cube: cubeProduct.stock,
            stock_shopify: shopifyProduct.stock,
            conflict_reason: conflictReason,
            shopify_modified: shopifyProduct.updated_at || '2025-01-10',
            cube_updated: cubeProduct.updated_at || '2025-01-15'
          });
        } else if (cubeProduct.stock !== shopifyProduct.stock) {
          // Stock update only
          syncData.updates.push({
            sku: cubeProduct.sku,
            title: cubeProduct.name,
            price_cube: cubeProduct.price,
            price_shopify: shopifyProduct.price,
            stock_cube: cubeProduct.stock,
            stock_shopify: shopifyProduct.stock,
            changes: [`Stock updated from ${shopifyProduct.stock} to ${cubeProduct.stock}`]
          });
        }
      }
    });
    
    return syncData;
    
  } catch (error) {
    console.error('Failed to fetch real sync data:', error);
    // Fallback to example data if API fails
    return {
      newProducts: [{
        sku: 'API-ERROR',
        title: 'API Connection Failed - Configure Cube credentials',
        price_cube: 0,
        price_shopify: null,
        stock_cube: 0,
        stock_shopify: null
      }],
      updates: [],
      conflicts: []
    };
  }
}

// Simulate Shopify products (would be real API call)
async function getShopifyProducts() {
  // This would be actual Shopify Admin API call
  // For now, return some example products that might exist
  return [
    {
      sku: 'CB-CNF-000-SPECIAL',
      name: 'Limited Edition Stereo Hybrid 160',
      price: 6499.00,
      stock: 2,
      updated_at: '2025-01-10'
    },
    {
      sku: 'CB-CNF-001-SPECIAL', 
      name: 'Custom Agree Hybrid C:62 SLT',
      price: 7999.00,
      stock: 1,
      updated_at: '2025-01-10'
    }
  ];
}

function showPreviewTab(tabName) {
  // Update tab buttons
  document.querySelectorAll('.preview-tab').forEach(tab => tab.classList.remove('active'));
  document.querySelector(`[onclick="showPreviewTab('${tabName}')"]`).classList.add('active');
  
  const contentDiv = document.querySelector('.sync-preview-content');
  const data = window.syncPreviewData;
  
  if (!data) {
    contentDiv.innerHTML = '<div id="sync-preview-loading">Loading...</div>';
    return;
  }
  
  let html = '';
  
  if (tabName === 'conflicts' && data.conflicts.length > 0) {
    html = '<div class="conflicts-list">';
    data.conflicts.forEach(conflict => {
      html += `
        <div class="conflict-item">
          <div class="conflict-header">
            <h4>${conflict.title}</h4>
            <span class="conflict-sku">${conflict.sku}</span>
            <span class="conflict-badge">CONFLICT</span>
          </div>
          <div class="conflict-reason">
            <strong>Conflict Reason:</strong> ${conflict.conflict_reason}
          </div>
          <div class="conflict-comparison">
            <div class="comparison-side">
              <h5>Shopify (Modified ${conflict.shopify_modified})</h5>
              <p>Price: ${conflict.price_shopify} CHF</p>
              <p>Stock: ${conflict.stock_shopify}</p>
            </div>
            <div class="comparison-side">
              <h5>Cube (Updated ${conflict.cube_updated})</h5>
              <p>Price: ${conflict.price_cube} CHF</p>
              <p>Stock: ${conflict.stock_cube}</p>
            </div>
          </div>
        </div>
      `;
    });
    html += '</div>';
  } else if (tabName === 'new-products' && data.newProducts.length > 0) {
    html = '<div class="new-products-list">';
    data.newProducts.forEach(product => {
      html += `
        <div class="new-product-item">
          <h4>${product.title}</h4>
          <p>SKU: ${product.sku}</p>
          <p>Price: ${product.price_cube} CHF</p>
          <p>Stock: ${product.stock_cube}</p>
        </div>
      `;
    });
    html += '</div>';
  } else if (tabName === 'updates' && data.updates.length > 0) {
    html = '<div class="updates-list">';
    data.updates.forEach(update => {
      html += `
        <div class="update-item">
          <h4>${update.title}</h4>
          <p>SKU: ${update.sku}</p>
          <div class="changes">
            ${update.changes.map(change => `<span class="change-item">${change}</span>`).join('')}
          </div>
        </div>
      `;
    });
    html += '</div>';
  } else {
    html = `<div class="no-data">No ${tabName.replace('-', ' ')} found</div>`;
  }
  
  contentDiv.innerHTML = html;
}

function exportSyncPreview() {
  const data = window.syncPreviewData;
  if (!data) return;
  
  // Create CSV data
  let csvContent = "data:text/csv;charset=utf-8,";
  
  // Add conflicts
  csvContent += "CONFLICTS\n";
  csvContent += "SKU,Product Title,Conflict Reason,Shopify Price,Cube Price,Shopify Stock,Cube Stock,Shopify Modified,Cube Updated\n";
  data.conflicts.forEach(item => {
    csvContent += `${item.sku},"${item.title}","${item.conflict_reason}",${item.price_shopify},${item.price_cube},${item.stock_shopify},${item.stock_cube},${item.shopify_modified},${item.cube_updated}\n`;
  });
  
  csvContent += "\nNEW PRODUCTS\n";
  csvContent += "SKU,Product Title,Price,Stock\n";
  data.newProducts.forEach(item => {
    csvContent += `${item.sku},"${item.title}",${item.price_cube},${item.stock_cube}\n`;
  });
  
  csvContent += "\nUPDATES\n";
  csvContent += "SKU,Product Title,Changes\n";
  data.updates.forEach(item => {
    csvContent += `${item.sku},"${item.title}","${item.changes.join('; ')}"\n`;
  });
  
  // Create download
  const encodedUri = encodeURI(csvContent);
  const link = document.createElement("a");
  link.setAttribute("href", encodedUri);
  link.setAttribute("download", `sync-preview-${new Date().toISOString().split('T')[0]}.csv`);
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
  
  showNotification('Sync preview exported to CSV file', 'success');
}

function previewSyncChanges() {
  showNotification('Preview functionality would show detailed changes...', 'info');
}

function approveSyncChanges() {
  showNotification('Sync approved - changes would be applied to Shopify', 'success');
  closeSyncPreview();
}

function closeSyncPreview() {
  const modal = document.querySelector('.sync-preview-modal');
  if (modal) {
    modal.remove();
  }
}

// Supplier-specific API client
async function fetchSupplierProducts(supplier, endpoint, credentials) {
  try {
    let response;
    
    switch (supplier) {
      case 'abus':
        // ABUS VeloConnect API
        response = await fetch(`${endpoint}/products`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Basic ${btoa(credentials.username + ':' + credentials.password)}`
          },
          body: JSON.stringify({
            apiKey: credentials.apiKey,
            limit: 100
          })
        });
        break;
        
      case 'amsler':
        // Amsler Web Service
        response = await fetch(`${endpoint}`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded'
          },
          body: new URLSearchParams({
            action: 'getProducts',
            username: credentials.username,
            password: credentials.password,
            clientId: credentials.clientId
          })
        });
        break;
        
      case 'chris-sports':
        // Chris Sports VeloCom
        response = await fetch(`${endpoint}/api/products`, {
          method: 'GET',
          headers: {
            'Authorization': `Bearer ${credentials.apiKey}`,
            'X-Store-ID': credentials.storeId
          }
        });
        break;
        
      case 'komenda':
        // Komenda VeloCom
        response = await fetch(`${endpoint}/api/products`, {
          method: 'GET',
          headers: {
            'X-API-Key': credentials.apiKey,
            'X-Account-ID': credentials.accountId
          }
        });
        break;
        
      case 'magura':
        // Magura VeloCom
        response = await fetch(`${endpoint}/api/authenticate`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            username: credentials.username,
            password: credentials.password
          })
        });
        
        if (response.ok) {
          const authData = await response.json();
          response = await fetch(`${endpoint}/api/products`, {
            headers: { 'Authorization': `Bearer ${authData.token}` }
          });
        }
        break;
        
      case 'maxxis':
        // Maxxis VeloStore
        response = await fetch(`${endpoint}/api/products`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            clientId: credentials.clientId,
            apiSecret: credentials.apiSecret
          })
        });
        break;
        
      case 'orbea':
        // Orbea VeloConnect (Trek-based)
        response = await fetch(`${endpoint}/products`, {
          method: 'GET',
          headers: {
            'Authorization': `Basic ${btoa(credentials.username + ':' + credentials.password)}`,
            'X-Dealer-ID': credentials.dealerId
          }
        });
        break;
        
      case 'sks':
        // SKS VeloCom
        response = await fetch(`${endpoint}/products`, {
          method: 'GET',
          headers: {
            'X-API-Key': credentials.apiKey,
            'X-Secret-Key': credentials.secretKey
          }
        });
        break;
        
      case 'tour-de-suisse':
        // Tour de Suisse
        response = await fetch(`${endpoint}/api/products`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            username: credentials.username,
            password: credentials.password,
            apiKey: credentials.apiKey
          })
        });
        break;
        
      default:
        throw new Error(`Unknown supplier: ${supplier}`);
    }
    
    if (!response.ok) {
      throw new Error(`HTTP ${response.status}: ${response.statusText}`);
    }
    
    const data = await response.json();
    
    // Normalize product data from different suppliers
    return normalizeProductData(supplier, data);
    
  } catch (error) {
    console.error(`${supplier} API error:`, error);
    throw new Error(`Failed to fetch from ${supplier}: ${error.message}`);
  }
}

// Normalize different supplier data formats
function normalizeProductData(supplier, data) {
  if (!data) return [];
  
  switch (supplier) {
    case 'abus':
      return data.products?.map(p => ({
        sku: p.articleNumber,
        name: p.productName,
        price: p.priceList?.retailPrice || 0,
        stock: p.stock || 0,
        updated_at: p.lastModified
      })) || [];
      
    case 'amsler':
      return data.items?.map(p => ({
        sku: p.SKU,
        name: p.Name,
        price: parseFloat(p.Price) || 0,
        stock: parseInt(p.Stock) || 0,
        updated_at: p.LastUpdate
      })) || [];
      
    case 'maxxis':
      return data.products?.map(p => ({
        sku: p.sku,
        name: p.title,
        price: p.price || 0,
        stock: p.quantity || 0,
        updated_at: p.modified_date
      })) || [];
      
    case 'orbea':
      return data.map(p => ({
        sku: p.model_code,
        name: p.model_name,
        price: p.msrp || 0,
        stock: p.stock_quantity || 0,
        updated_at: p.last_updated
      })) || [];
      
    default:
      // Generic format
      return Array.isArray(data) ? data : data.products || [];
  }
}

function checkAPIs() {
  showNotification('Running API health check...', 'info');
  
  // Switch to monitoring section
  document.querySelector('[data-section="monitoring"]').click();
  
  setTimeout(() => {
    // Update performance metrics with new values
    document.getElementById('avg-response-time').textContent = Math.floor(Math.random() * 100 + 150) + 'ms';
    document.getElementById('success-rate').textContent = (Math.random() * 5 + 95).toFixed(1) + '%';
    document.getElementById('system-uptime').textContent = (Math.random() * 0.5 + 99.5).toFixed(1) + '%';
    
    showNotification('API health check completed - all systems operational', 'success');
  }, 2000);
}

// Quick action functions for Overview section
function showSyncStatus() {
  showNotification('Navigating to Data Sync Status...', 'info');
  document.querySelector('[data-section="monitoring"]').click();
}

function viewLogs() {
  showNotification('Opening system logs...', 'info');
  document.querySelector('[data-section="monitoring"]').click();
  
  setTimeout(() => {
    // Highlight the logs section
    const logsCard = document.querySelector('.monitoring-card h4').closest('.monitoring-card');
    if (logsCard) {
      logsCard.style.border = '2px solid #ff4040';
      setTimeout(() => {
        logsCard.style.border = '1px solid #e8ecef';
      }, 3000);
    }
  }, 500);
}

function testAIChat() {
  showNotification('Opening AI Chat configuration for testing...', 'info');
  showToolConfig('ai-chat');
}

// Show notification
function showNotification(message, type = 'info') {
  // Create notification element
  const notification = document.createElement('div');
  notification.className = `notification notification-${type}`;
  notification.innerHTML = `
    <div class="notification-content">
      <span class="notification-message">${message}</span>
      <button class="notification-close" onclick="this.parentElement.parentElement.remove()">Ã—</button>
    </div>
  `;
  
  // Add styles
  notification.style.cssText = `
    position: fixed;
    top: 20px;
    right: 20px;
    background: ${type === 'success' ? '#d4edda' : type === 'error' ? '#f8d7da' : '#d1ecf1'};
    color: ${type === 'success' ? '#155724' : type === 'error' ? '#721c24' : '#0c5460'};
    padding: 1rem;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    z-index: 10000;
    max-width: 400px;
    animation: slideIn 0.3s ease;
  `;
  
  // Add animation styles
  const style = document.createElement('style');
  style.textContent = `
    @keyframes slideIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
  `;
  document.head.appendChild(style);
  
  // Add to page
  document.body.appendChild(notification);
  
  // Auto-remove after 5 seconds
  setTimeout(() => {
    if (notification.parentElement) {
      notification.remove();
    }
  }, 5000);
}

// Show tool configuration modal
function showToolConfig(toolName) {
  const modal = document.getElementById('tool-configuration-modal');
  const modalTitle = document.getElementById('config-modal-title');
  
  if (!modal || !modalTitle) {
    console.error('Tool configuration modal elements not found');
    return;
  }
  
  // Set the modal title based on the tool
  const toolTitles = {
    'ai-chat': 'AI Chat Configuration',
    'qr-codes': 'QR Code Generator Configuration', 
    'workshop-booking': 'Workshop Booking Configuration',
    'cube-integration': 'Cube Integration Configuration',
    'veloconnect': 'VeloConnect Configuration'
  };
  
  modalTitle.textContent = toolTitles[toolName] || 'Tool Configuration';
  
  // Show all relevant tab buttons
  const tabNavigation = modal.querySelector('.tab-navigation');
  if (tabNavigation) {
    const buttons = tabNavigation.querySelectorAll('.tab-btn');
    buttons.forEach(btn => {
      if (btn.dataset.tab === toolName) {
        btn.classList.add('active');
        btn.click(); // Trigger the tab switch
      } else {
        btn.classList.remove('active');
      }
    });
  }
  
  // Show the modal
  modal.style.display = 'block';
  document.body.style.overflow = 'hidden'; // Prevent background scrolling
  
  // Focus on the modal for accessibility
  modal.focus();
}

// Close tool configuration modal
function closeToolConfig() {
  const modal = document.getElementById('tool-configuration-modal');
  if (modal) {
    modal.style.display = 'none';
    document.body.style.overflow = ''; // Restore scrolling
  }
}

// Show notification modal (alternative to inline notifications)
function showNotificationModal(message, type = 'info') {
  // Create modal element
  const modal = document.createElement('div');
  modal.className = 'notification-modal';
  modal.style.cssText = `
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.5);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 10001;
  `;
  
  // Create modal content
  const content = document.createElement('div');
  content.className = 'notification-modal-content';
  content.style.cssText = `
    background: white;
    padding: 2rem;
    border-radius: 8px;
    max-width: 400px;
    width: 90%;
    text-align: center;
    box-shadow: 0 4px 20px rgba(0,0,0,0.3);
  `;
  
  // Set content based on type
  const icon = type === 'success' ? 'âœ“' : type === 'error' ? 'âœ—' : 'â„¹';
  const color = type === 'success' ? '#28a745' : type === 'error' ? '#dc3545' : '#17a2b8';
  
  content.innerHTML = `
    <div style="color: ${color}; font-size: 3rem; margin-bottom: 1rem;">${icon}</div>
    <p style="margin: 0 0 1.5rem 0; font-size: 1.1rem;">${message}</p>
    <button onclick="this.closest('.notification-modal').remove(); document.body.style.overflow = '';" 
            style="background: ${color}; color: white; border: none; padding: 0.5rem 1.5rem; border-radius: 4px; cursor: pointer;">
      OK
    </button>
  `;
  
  modal.appendChild(content);
  document.body.appendChild(modal);
  document.body.style.overflow = 'hidden';
  
  // Close on background click
  modal.addEventListener('click', function(e) {
    if (e.target === modal) {
      modal.remove();
      document.body.style.overflow = '';
    }
  });
  
  // Auto-close after 5 seconds for non-error messages
  if (type !== 'error') {
    setTimeout(() => {
      if (modal.parentElement) {
        modal.remove();
        document.body.style.overflow = '';
      }
    }, 5000);
  }
}

// Save supplier credentials
async function saveSupplierCredentials(supplier) {
  showNotification(`Saving ${supplier.toUpperCase()} credentials...`, 'info');
  
  try {
    // Get form elements for the supplier
    const supplierConfig = document.querySelector(`#${supplier}-integration-config`) || 
                          document.querySelector(`#${supplier}-config`) ||
                          document.querySelector(`[data-supplier="${supplier}"]`);
    
    if (!supplierConfig) {
      throw new Error(`Configuration form not found for ${supplier}`);
    }
    
    // Collect form data based on supplier type
    const formData = {};
    const inputs = supplierConfig.querySelectorAll('input, select, textarea');
    
    inputs.forEach(input => {
      if (input.id || input.name) {
        const key = input.id || input.name;
        if (input.type === 'checkbox') {
          formData[key] = input.checked;
        } else if (input.type === 'radio') {
          if (input.checked) {
            formData[key] = input.value;
          }
        } else {
          formData[key] = input.value;
        }
      }
    });
    
    // Validate required fields based on supplier type
    const requiredFields = getRequiredFieldsForSupplier(supplier);
    const missingFields = [];
    
    requiredFields.forEach(field => {
      if (!formData[field] || formData[field].trim() === '') {
        missingFields.push(field);
      }
    });
    
    if (missingFields.length > 0) {
      throw new Error(`Missing required fields: ${missingFields.join(', ')}`);
    }
    
    // Use existing credentials manager to save
    if (!window.GodspeedCredentials) {
      throw new Error('Credentials manager not available');
    }
    
    await window.GodspeedCredentials.saveCredentials(supplier, formData);
    
    // Update UI status
    updateSupplierConfigStatus(supplier, 'configured');
    
    showNotification(`${supplier.toUpperCase()} credentials saved successfully!`, 'success');
    
  } catch (error) {
    console.error(`Error saving ${supplier} credentials:`, error);
    showNotification(`Failed to save ${supplier.toUpperCase()} credentials: ${error.message}`, 'error');
  }
}

// Test supplier connection
async function testSupplierConnection(supplier) {
  const btn = document.querySelector(`[onclick="testSupplierConnection('${supplier}')"]`) ||
             document.querySelector(`[data-supplier="${supplier}"] .test-connection-btn`) ||
             document.querySelector(`#test-${supplier}-btn`);
  
  if (btn) {
    const originalText = btn.innerHTML;
    btn.innerHTML = '<i class="fa fa-spinner fa-spin"></i> Testing...';
    btn.disabled = true;
  }
  
  showNotification(`Testing ${supplier.toUpperCase()} connection...`, 'info');
  
  try {
    // Get credentials for the supplier
    if (!window.GodspeedCredentials) {
      throw new Error('Credentials manager not available');
    }
    
    const credentials = await window.GodspeedCredentials.getCredentials(supplier);
    if (!credentials) {
      throw new Error(`No credentials configured for ${supplier.toUpperCase()}`);
    }
    
    let testResult;
    
    // Test connection based on supplier type
    switch (supplier.toLowerCase()) {
      case 'cube':
        testResult = await testCubeConnection(credentials);
        break;
      case 'veloconnect':
        testResult = await testVeloConnectConnection(credentials);
        break;
      case 'magura':
        testResult = await testMaguraConnection(credentials);
        break;
      case 'shimano':
        testResult = await testShimanoConnection(credentials);
        break;
      case 'sram':
        testResult = await testSramConnection(credentials);
        break;
      default:
        testResult = await testGenericSupplierConnection(supplier, credentials);
        break;
    }
    
    if (testResult.success) {
      showNotification(`${supplier.toUpperCase()} connection successful! Response time: ${testResult.responseTime}ms`, 'success');
      updateSupplierConnectionStatus(supplier, 'connected', testResult.responseTime);
    } else {
      throw new Error(testResult.error || 'Connection test failed');
    }
    
  } catch (error) {
    console.error(`Error testing ${supplier} connection:`, error);
    showNotification(`${supplier.toUpperCase()} connection failed: ${error.message}`, 'error');
    updateSupplierConnectionStatus(supplier, 'error', null);
  } finally {
    if (btn) {
      btn.innerHTML = originalText;
      btn.disabled = false;
    }
  }
}

// Helper function to get required fields based on supplier type
function getRequiredFieldsForSupplier(supplier) {
  const fieldMap = {
    cube: ['api-key', 'mode'],
    veloconnect: ['username', 'password', 'endpoint'],
    magura: ['api-key', 'client-id'],
    shimano: ['api-key', 'region'],
    sram: ['oauth-token', 'client-id']
  };
  
  return fieldMap[supplier.toLowerCase()] || ['username', 'password'];
}

// Helper function to update supplier configuration status
function updateSupplierConfigStatus(supplier, status) {
  const statusElement = document.querySelector(`#${supplier}-config-status`) ||
                       document.querySelector(`[data-supplier="${supplier}"] .config-status`) ||
                       document.querySelector(`#${supplier}-status`);
  
  if (statusElement) {
    statusElement.className = `status-indicator ${status}`;
    const statusText = {
      'configured': 'Configured',
      'pending': 'Configuration Required',
      'error': 'Configuration Error'
    };
    statusElement.textContent = statusText[status] || status;
  }
}

// Helper function to update supplier connection status
function updateSupplierConnectionStatus(supplier, status, responseTime) {
  const statusElement = document.querySelector(`#${supplier}-connection-status`) ||
                       document.querySelector(`[data-supplier="${supplier}"] .connection-status`) ||
                       document.querySelector(`#${supplier}-api-status`);
  
  if (statusElement) {
    statusElement.className = `status-indicator ${status === 'connected' ? 'online' : status}`;
    if (status === 'connected' && responseTime) {
      statusElement.textContent = `Connected (${responseTime}ms)`;
    } else {
      const statusText = {
        'connected': 'Connected',
        'error': 'Connection Failed',
        'offline': 'Offline'
      };
      statusElement.textContent = statusText[status] || status;
    }
  }
}

// Supplier-specific connection test functions
async function testCubeConnection(credentials) {
  const startTime = Date.now();
  
  try {
    if (credentials.mode === 'direct') {
      // Test direct Cube API
      const response = await fetch('https://api.cube.eu/v1/test', {
        method: 'GET',
        headers: {
          'Authorization': `Bearer ${credentials['api-key']}`,
          'Content-Type': 'application/json'
        }
      });
      
      if (response.ok) {
        return {
          success: true,
          responseTime: Date.now() - startTime
        };
      } else {
        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
      }
    } else {
      // Test VeloConnect integration
      const response = await fetch('https://Veloconnect.cube.eu/Veloconnect', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded'
        },
        body: new URLSearchParams({
          username: credentials.username,
          password: credentials.password,
          action: 'test'
        })
      });
      
      if (response.ok) {
        return {
          success: true,
          responseTime: Date.now() - startTime
        };
      } else {
        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
      }
    }
  } catch (error) {
    return {
      success: false,
      error: error.message
    };
  }
}

async function testVeloConnectConnection(credentials) {
  const startTime = Date.now();
  
  try {
    const response = await fetch(credentials.endpoint || 'https://api.veloconnect.com/test', {
      method: 'POST',
      headers: {
        'Authorization': `Basic ${btoa(credentials.username + ':' + credentials.password)}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ action: 'test' })
    });
    
    if (response.ok) {
      return {
        success: true,
        responseTime: Date.now() - startTime
      };
    } else {
      throw new Error(`HTTP ${response.status}: ${response.statusText}`);
    }
  } catch (error) {
    return {
      success: false,
      error: error.message
    };
  }
}

async function testMaguraConnection(credentials) {
  const startTime = Date.now();
  
  try {
    const response = await fetch('https://api.magura.com/v1/test', {
      method: 'GET',
      headers: {
        'X-API-Key': credentials['api-key'],
        'X-Client-ID': credentials['client-id'],
        'Content-Type': 'application/json'
      }
    });
    
    if (response.ok) {
      return {
        success: true,
        responseTime: Date.now() - startTime
      };
    } else {
      throw new Error(`HTTP ${response.status}: ${response.statusText}`);
    }
  } catch (error) {
    return {
      success: false,
      error: error.message
    };
  }
}

async function testShimanoConnection(credentials) {
  const startTime = Date.now();
  
  try {
    const response = await fetch(`https://api.shimano.${credentials.region || 'com'}/v1/test`, {
      method: 'GET',
      headers: {
        'Authorization': `Bearer ${credentials['api-key']}`,
        'Content-Type': 'application/json'
      }
    });
    
    if (response.ok) {
      return {
        success: true,
        responseTime: Date.now() - startTime
      };
    } else {
      throw new Error(`HTTP ${response.status}: ${response.statusText}`);
    }
  } catch (error) {
    return {
      success: false,
      error: error.message
    };
  }
}

async function testSramConnection(credentials) {
  const startTime = Date.now();
  
  try {
    const response = await fetch('https://api.sram.com/v1/test', {
      method: 'GET',
      headers: {
        'Authorization': `Bearer ${credentials['oauth-token']}`,
        'X-Client-ID': credentials['client-id'],
        'Content-Type': 'application/json'
      }
    });
    
    if (response.ok) {
      return {
        success: true,
        responseTime: Date.now() - startTime
      };
    } else {
      throw new Error(`HTTP ${response.status}: ${response.statusText}`);
    }
  } catch (error) {
    return {
      success: false,
      error: error.message
    };
  }
}

async function testGenericSupplierConnection(supplier, credentials) {
  const startTime = Date.now();
  
  try {
    // For unknown suppliers, attempt a generic test
    const endpoint = credentials.endpoint || credentials.url || `https://api.${supplier}.com/test`;
    const headers = {
      'Content-Type': 'application/json'
    };
    
    // Add authentication based on available credentials
    if (credentials['api-key']) {
      headers['Authorization'] = `Bearer ${credentials['api-key']}`;
    } else if (credentials.username && credentials.password) {
      headers['Authorization'] = `Basic ${btoa(credentials.username + ':' + credentials.password)}`;
    }
    
    const response = await fetch(endpoint, {
      method: 'GET',
      headers: headers
    });
    
    if (response.ok) {
      return {
        success: true,
        responseTime: Date.now() - startTime
      };
    } else {
      throw new Error(`HTTP ${response.status}: ${response.statusText}`);
    }
  } catch (error) {
    return {
      success: false,
      error: error.message
    };
  }
}

</script>

{% schema %}
{
  "name": "Admin Dashboard",
  "settings": [
    {
      "type": "text",
      "id": "dashboard_title",
      "label": "Dashboard Title",
      "default": "Admin Tools & API Management"
    },
    {
      "type": "textarea",
      "id": "dashboard_subtitle",
      "label": "Dashboard Subtitle",
      "default": "Centralized dashboard for managing all your e-bike business tools, API credentials, and system configurations."
    },
    {
      "type": "header",
      "content": "Colors"
    },
    {
      "type": "color",
      "id": "color_title",
      "label": "Title Color",
      "default": "#333"
    },
    {
      "type": "color",
      "id": "color_subtitle",
      "label": "Subtitle Color",
      "default": "#6c757d"
    },
    {
      "type": "header",
      "content": "Spacing"
    },
    {
      "type": "range",
      "id": "margin_top",
      "min": 0,
      "max": 100,
      "step": 5,
      "unit": "px",
      "label": "Margin Top",
      "default": 0
    },
    {
      "type": "range",
      "id": "margin_bottom",
      "min": 0,
      "max": 100,
      "step": 5,
      "unit": "px",
      "label": "Margin Bottom",
      "default": 0
    }
  ],
  "presets": [
    {
      "name": "Admin Dashboard",
      "category": "Admin Tools"
    }
  ]
}
{% endschema %}
