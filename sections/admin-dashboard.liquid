{% comment %}
  Admin Dashboard Section
  Centralized management interface for all tools and APIs
{% endcomment %}

<div data-section-id="{{ section.id }}" data-section-type="section-admin-dashboard" style="{% if section.settings.margin_top != blank %}margin-top: {{section.settings.margin_top}}px;{%endif%} {% if section.settings.margin_bottom != blank %}margin-bottom: {{section.settings.margin_bottom}}px;{% endif %}">
  <div class="section-admin-dashboard mt-all">
    <div class="container container-v2">
      <div class="row justify-content-center">
        <div class="col-lg-12 col-md-12 col-sm-12">
          <div class="dashboard-header text-center mb-5">
            {% if section.settings.dashboard_title != blank %}
              <h2 class="title title-{{ section.id }} mb-3">{{ section.settings.dashboard_title }}</h2>
            {% endif %}
            
            {% if section.settings.dashboard_subtitle != blank %}
              <p class="subtitle subtitle-{{ section.id }}">{{ section.settings.dashboard_subtitle }}</p>
            {% endif %}
          </div>
          
          <div class="dashboard-wrapper">
            <div class="row">
              <!-- Tool Status Overview -->
              <div class="col-lg-8 col-md-12 mb-4">
                <div class="tools-overview">
                  <h4 class="section-title section-title-{{ section.id }} mb-4">System Status Overview</h4>
                  
                  <div class="status-grid">
                    <div class="status-card status-online">
                      <div class="status-icon">
                        <i class="fa fa-check-circle"></i>
                      </div>
                      <div class="status-content">
                        <h5>AI Chat Assistant</h5>
                        <p>Online & Active</p>
                        <span class="status-badge">Live</span>
                      </div>
                    </div>
                    
                    <div class="status-card status-online">
                      <div class="status-icon">
                        <i class="fa fa-check-circle"></i>
                      </div>
                      <div class="status-content">
                        <h5>Workshop Booking</h5>
                        <p>Google Cloud Connected</p>
                        <span class="status-badge">Live</span>
                      </div>
                    </div>
                    
                    <div class="status-card status-online">
                      <div class="status-icon">
                        <i class="fa fa-check-circle"></i>
                      </div>
                      <div class="status-content">
                        <h5>Cube Integration</h5>
                        <p>API Connected</p>
                        <span class="status-badge">Live</span>
                      </div>
                    </div>
                    
                    <div class="status-card status-pending">
                      <div class="status-icon">
                        <i class="fa fa-clock-o"></i>
                      </div>
                      <div class="status-content">
                        <h5>VeloConnect</h5>
                        <p>Configuration Required</p>
                        <span class="status-badge">Setup</span>
                      </div>
                    </div>
                  </div>
                </div>
                
                <!-- Quick Actions -->
                <div class="quick-actions mt-4">
                  <h4 class="section-title section-title-{{ section.id }} mb-3">Quick Actions</h4>
                  
                  <div class="action-buttons">
                    <button class="btn btn-action" onclick="testAIChat()">
                      <i class="fa fa-comments"></i> Test AI Chat
                    </button>
                    <button class="btn btn-action" onclick="checkAPIs()">
                      <i class="fa fa-plug"></i> Check API Health
                    </button>
                    <button class="btn btn-action" onclick="viewLogs()">
                      <i class="fa fa-list"></i> View System Logs
                    </button>
                    <button class="btn btn-action" onclick="exportData()">
                      <i class="fa fa-download"></i> Export Data
                    </button>
                  </div>
                </div>
              </div>
              
              <!-- System Metrics -->
              <div class="col-lg-4 col-md-12">
                <div class="system-metrics">
                  <h4 class="section-title section-title-{{ section.id }} mb-3">System Metrics</h4>
                  
                  <div class="metric-cards">
                    <div class="metric-card">
                      <div class="metric-header">
                        <h5>Chat Sessions</h5>
                        <i class="fa fa-comments"></i>
                      </div>
                      <div class="metric-value" id="chat-sessions-count">0</div>
                      <div class="metric-change positive">+12% this week</div>
                    </div>
                    
                    <div class="metric-card">
                      <div class="metric-header">
                        <h5>Service Bookings</h5>
                        <i class="fa fa-calendar"></i>
                      </div>
                      <div class="metric-value" id="bookings-count">0</div>
                      <div class="metric-change positive">+8% this week</div>
                    </div>
                    
                    <div class="metric-card">
                      <div class="metric-header">
                        <h5>API Calls</h5>
                        <i class="fa fa-exchange"></i>
                      </div>
                      <div class="metric-value" id="api-calls-count">0</div>
                      <div class="metric-change neutral">0% change</div>
                    </div>
                    
                    <div class="metric-card">
                      <div class="metric-header">
                        <h5>System Uptime</h5>
                        <i class="fa fa-server"></i>
                      </div>
                      <div class="metric-value" id="uptime-percentage">99.9%</div>
                      <div class="metric-change positive">+0.1% this month</div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Tool Configuration -->
            <div class="row mt-5">
              <div class="col-12">
                <div class="tool-configuration">
                  <h4 class="section-title section-title-{{ section.id }} mb-4">Tool Configuration</h4>
                  
                  <div class="config-tabs">
                    <div class="tab-navigation">
                      <button class="tab-btn active" data-tab="ai-chat">AI Chat</button>
                      <button class="tab-btn" data-tab="workshop-booking">Workshop Booking</button>
                      <button class="tab-btn" data-tab="qr-codes">QR Codes</button>
                      <button class="tab-btn" data-tab="cube-integration">Cube Integration</button>
                      <button class="tab-btn" data-tab="veloconnect">VeloConnect</button>
                    </div>
                    
                    <div class="tab-content">
                      <!-- AI Chat Configuration -->
                      <div class="tab-pane active" id="ai-chat-config">
                        <div class="config-form">
                          <div class="alert alert-warning mb-4">
                            <strong>‚ö†Ô∏è AI Chat Setup Required</strong><br>
                            To enable the AI Chat Assistant, you need to configure an AI API provider below.
                          </div>
                          
                          <div class="row">
                            <div class="col-lg-6 col-md-6 col-sm-12 mb-3">
                              <label class="form-label">AI Provider</label>
                              <select class="form-control" id="ai-provider-select">
                                <option value="">Select AI Provider</option>
                                <option value="openai">OpenAI (ChatGPT)</option>
                                <option value="claude">Anthropic Claude</option>
                                <option value="gemini">Google Gemini</option>
                              </select>
                            </div>
                            <div class="col-lg-6 col-md-6 col-sm-12 mb-3">
                              <label class="form-label">API Key</label>
                              <input type="password" class="form-control" placeholder="Enter your API key" id="ai-api-key">
                              <small class="form-text text-muted">Your API key is encrypted and stored securely</small>
                            </div>
                          </div>
                          
                          <div class="row">
                            <div class="col-lg-6 col-md-6 col-sm-12 mb-3">
                              <label class="form-label">Chat Title</label>
                              <input type="text" class="form-control" value="Godspeed E-Bike Expert" id="chat-title-input">
                            </div>
                            <div class="col-lg-6 col-md-6 col-sm-12 mb-3">
                              <label class="form-label">Model</label>
                              <select class="form-control" id="ai-model-select">
                                <option value="gpt-4">GPT-4 (Recommended)</option>
                                <option value="gpt-3.5-turbo">GPT-3.5 Turbo (Faster)</option>
                                <option value="claude-3-sonnet">Claude 3 Sonnet</option>
                                <option value="gemini-pro">Gemini Pro</option>
                              </select>
                            </div>
                          </div>
                          
                          <div class="row">
                            <div class="col-12 mb-3">
                              <label class="form-label">System Prompt</label>
                              <textarea class="form-control" rows="4" id="system-prompt-input">You are an expert assistant for Godspeed E-Bike shop in Switzerland. You help customers with:
- E-bike recommendations based on needs
- Technical specifications and comparisons
- Service appointments and maintenance
- Pricing in Swiss Francs (CHF)
- Local cycling routes and tips

Always be helpful, friendly, and knowledgeable about e-bikes, cycling, and Swiss locations.</textarea>
                            </div>
                          </div>
                          
                          <div class="row">
                            <div class="col-lg-6 col-md-6 col-sm-12 mb-3">
                              <label class="form-label">Welcome Message</label>
                              <textarea class="form-control" rows="2" id="welcome-message-input">Hello! I'm your Godspeed e-bike expert. How can I help you find the perfect bike or schedule service today?</textarea>
                            </div>
                            <div class="col-lg-6 col-md-6 col-sm-12 mb-3">
                              <label class="form-label">Max Messages per Conversation</label>
                              <input type="number" class="form-control" value="20" min="5" max="50" id="max-messages-input">
                            </div>
                          </div>
                          
                          <div class="row">
                            <div class="col-lg-6 col-md-6 col-sm-12 mb-3">
                              <label class="form-label">Button Color</label>
                              <input type="color" class="form-control" value="#333333" id="button-color-input">
                            </div>
                            <div class="col-lg-6 col-md-6 col-sm-12 mb-3">
                              <label class="form-label">Header Color</label>
                              <input type="color" class="form-control" value="#f8f9fa" id="header-color-input">
                            </div>
                          </div>
                          
                          <div class="form-actions">
                            <button class="btn btn-test" onclick="testAIChatConnection()" id="test-ai-btn">
                              <i class="fa fa-plug"></i> Test Connection
                            </button>
                            <button class="btn btn-save" onclick="saveAIChatConfig()">
                              <i class="fa fa-save"></i> Save AI Chat Settings
                            </button>
                          </div>
                          
                          <div class="mt-4" id="ai-chat-status" style="display: none;">
                            <!-- Status messages will appear here -->
                          </div>
                          
                          <!-- Recent Chat Sessions -->
                          <div class="mt-5">
                            <h5>Recent Chat Sessions</h5>
                            <div class="chat-sessions-list" id="recent-chat-sessions">
                              <div class="session-item">
                                <div class="session-info">
                                  <span class="session-time">2 hours ago</span>
                                  <span class="session-messages">5 messages</span>
                                </div>
                                <div class="session-preview">Customer asked about e-mountain bike recommendations for Swiss Alps...</div>
                                <button class="btn btn-sm btn-outline" onclick="viewChatSession('session-1')">View</button>
                              </div>
                              <div class="session-item">
                                <div class="session-info">
                                  <span class="session-time">1 day ago</span>
                                  <span class="session-messages">8 messages</span>
                                </div>
                                <div class="session-preview">Service appointment inquiry for battery maintenance...</div>
                                <button class="btn btn-sm btn-outline" onclick="viewChatSession('session-2')">View</button>
                              </div>
                            </div>
                            <button class="btn btn-secondary btn-sm mt-2" onclick="loadMoreChatSessions()">Load More Sessions</button>
                          </div>
                        </div>
                      </div>
                      
                      <!-- Workshop Booking Configuration -->
                      <div class="tab-pane" id="workshop-booking-config">
                        <div class="config-form">
                          <!-- Recent Bookings -->
                          <div class="row mb-4">
                            <div class="col-12">
                              <h5>Recent Service Bookings</h5>
                              <div class="bookings-list" id="recent-bookings">
                                <div class="booking-item">
                                  <div class="booking-info">
                                    <div class="booking-date">Today, 14:00</div>
                                    <div class="booking-service">E-Bike Maintenance</div>
                                    <div class="booking-customer">M. Fischer - Lugano</div>
                                  </div>
                                  <div class="booking-actions">
                                    <span class="booking-status confirmed">Confirmed</span>
                                    <button class="btn btn-sm btn-outline" onclick="viewBooking('booking-1')">View</button>
                                  </div>
                                </div>
                                <div class="booking-item">
                                  <div class="booking-info">
                                    <div class="booking-date">Tomorrow, 10:30</div>
                                    <div class="booking-service">Battery Diagnostics</div>
                                    <div class="booking-customer">S. Weber - Bellinzona</div>
                                  </div>
                                  <div class="booking-actions">
                                    <span class="booking-status pending">Pending</span>
                                    <button class="btn btn-sm btn-outline" onclick="viewBooking('booking-2')">View</button>
                                  </div>
                                </div>
                                <div class="booking-item">
                                  <div class="booking-info">
                                    <div class="booking-date">Jan 30, 15:15</div>
                                    <div class="booking-service">Complete Service</div>
                                    <div class="booking-customer">A. Rossi - Locarno</div>
                                  </div>
                                  <div class="booking-actions">
                                    <span class="booking-status confirmed">Confirmed</span>
                                    <button class="btn btn-sm btn-outline" onclick="viewBooking('booking-3')">View</button>
                                  </div>
                                </div>
                              </div>
                              <button class="btn btn-secondary btn-sm" onclick="loadMoreBookings()">Load More Bookings</button>
                            </div>
                          </div>
                          
                          <!-- API Configuration -->
                          <div class="row">
                            <div class="col-lg-6 col-md-6 col-sm-12 mb-3">
                              <label class="form-label">Google Cloud Function URL</label>
                              <input type="text" class="form-control" value="https://bookings-api-802427545823.europe-west6.run.app/bookings/service" readonly>
                            </div>
                            <div class="col-lg-6 col-md-6 col-sm-12 mb-3">
                              <label class="form-label">API Status</label>
                              <span class="status-indicator online" id="workshop-api-status">Online</span>
                            </div>
                          </div>
                          <div class="row">
                            <div class="col-lg-6 col-md-6 col-sm-12 mb-3">
                              <label class="form-label">Service Locations</label>
                              <div class="location-list">
                                <div class="location-item">
                                  <input type="checkbox" checked> Lugano Workshop
                                </div>
                                <div class="location-item">
                                  <input type="checkbox" checked> Bellinzona Store
                                </div>
                                <div class="location-item">
                                  <input type="checkbox" checked> Locarno Store
                                </div>
                                <div class="location-item">
                                  <input type="checkbox" checked> Zurich Store
                                </div>
                              </div>
                            </div>
                            <div class="col-lg-6 col-md-6 col-sm-12 mb-3">
                              <label class="form-label">Booking Hours</label>
                              <input type="text" class="form-control" value="09:00 - 17:00 (Mon-Fri)" readonly>
                            </div>
                          </div>
                          <div class="form-actions">
                            <button class="btn btn-test" onclick="testWorkshopAPI()">
                              <i class="fa fa-plug"></i> Test Workshop API
                            </button>
                            <button class="btn btn-secondary" onclick="refreshBookings()">
                              <i class="fa fa-refresh"></i> Refresh Bookings
                            </button>
                          </div>
                        </div>
                      </div>

                      <!-- QR Code Management -->
                      <div class="tab-pane" id="qr-codes-config">
                        <div class="config-form">
                          <div class="alert alert-info mb-4">
                            <strong>üì± QR Code Integration</strong><br>
                            Generate QR codes for products so customers can scan and be taken directly to the product page.
                          </div>
                          
                          <div class="row mb-4">
                            <div class="col-lg-8 col-md-8 col-sm-12">
                              <label class="form-label">Product Search</label>
                              <input type="text" class="form-control" placeholder="Search products to generate QR codes..." id="product-search-input">
                            </div>
                            <div class="col-lg-4 col-md-4 col-sm-12">
                              <label class="form-label">&nbsp;</label>
                              <button class="btn btn-primary btn-block" onclick="searchProducts()">
                                <i class="fa fa-search"></i> Search Products
                              </button>
                            </div>
                          </div>
                          
                          <!-- QR Code Generation -->
                          <div class="row mb-4">
                            <div class="col-lg-6 col-md-6 col-sm-12">
                              <h5>Generate QR Code</h5>
                              <div class="qr-generator">
                                <input type="text" class="form-control mb-2" placeholder="Product URL or Handle" id="qr-product-url">
                                <input type="text" class="form-control mb-2" placeholder="QR Code Label (optional)" id="qr-label">
                                <button class="btn btn-success" onclick="generateQRCode()">
                                  <i class="fa fa-qrcode"></i> Generate QR Code
                                </button>
                              </div>
                            </div>
                            <div class="col-lg-6 col-md-6 col-sm-12">
                              <h5>QR Code Preview</h5>
                              <div class="qr-preview" id="qr-preview">
                                <div class="qr-placeholder">
                                  <i class="fa fa-qrcode fa-3x"></i>
                                  <p>QR Code will appear here</p>
                                </div>
                              </div>
                              <div class="qr-actions mt-2" id="qr-actions" style="display: none;">
                                <button class="btn btn-sm btn-primary" onclick="downloadQRCode()">
                                  <i class="fa fa-download"></i> Download PNG
                                </button>
                                <button class="btn btn-sm btn-secondary" onclick="downloadQRCodeSVG()">
                                  <i class="fa fa-vector-square"></i> Download SVG
                                </button>
                              </div>
                            </div>
                          </div>
                          
                          <!-- Existing QR Codes -->
                          <div class="row">
                            <div class="col-12">
                              <h5>Existing QR Codes</h5>
                              <div class="qr-codes-list" id="existing-qr-codes">
                                <div class="qr-code-item">
                                  <div class="qr-info">
                                    <div class="qr-product">Cube Stereo Hybrid 140 HPC</div>
                                    <div class="qr-url">https://godspeed-bike.com/products/cube-stereo-hybrid-140</div>
                                    <div class="qr-created">Created: 3 days ago</div>
                                  </div>
                                  <div class="qr-thumbnail">
                                    <canvas width="60" height="60" id="qr-thumb-1"></canvas>
                                  </div>
                                  <div class="qr-actions">
                                    <button class="btn btn-sm btn-outline" onclick="viewQRCode('qr-1')">View</button>
                                    <button class="btn btn-sm btn-outline" onclick="downloadQR('qr-1')">Download</button>
                                    <button class="btn btn-sm btn-danger" onclick="deleteQRCode('qr-1')">Delete</button>
                                  </div>
                                </div>
                                <div class="qr-code-item">
                                  <div class="qr-info">
                                    <div class="qr-product">Trek Fuel EXe 9.8 XT</div>
                                    <div class="qr-url">https://godspeed-bike.com/products/trek-fuel-exe</div>
                                    <div class="qr-created">Created: 1 week ago</div>
                                  </div>
                                  <div class="qr-thumbnail">
                                    <canvas width="60" height="60" id="qr-thumb-2"></canvas>
                                  </div>
                                  <div class="qr-actions">
                                    <button class="btn btn-sm btn-outline" onclick="viewQRCode('qr-2')">View</button>
                                    <button class="btn btn-sm btn-outline" onclick="downloadQR('qr-2')">Download</button>
                                    <button class="btn btn-sm btn-danger" onclick="deleteQRCode('qr-2')">Delete</button>
                                  </div>
                                </div>
                              </div>
                              <button class="btn btn-secondary btn-sm" onclick="loadMoreQRCodes()">Load More QR Codes</button>
                            </div>
                          </div>
                          
                          <!-- QR Code Settings -->
                          <div class="row mt-4">
                            <div class="col-12">
                              <h5>QR Code Settings</h5>
                              <div class="row">
                                <div class="col-lg-3 col-md-6 col-sm-12 mb-3">
                                  <label class="form-label">Size</label>
                                  <select class="form-control" id="qr-size">
                                    <option value="200">Small (200px)</option>
                                    <option value="400" selected>Medium (400px)</option>
                                    <option value="600">Large (600px)</option>
                                    <option value="1000">Extra Large (1000px)</option>
                                  </select>
                                </div>
                                <div class="col-lg-3 col-md-6 col-sm-12 mb-3">
                                  <label class="form-label">Error Correction</label>
                                  <select class="form-control" id="qr-error-correction">
                                    <option value="L">Low (7%)</option>
                                    <option value="M" selected>Medium (15%)</option>
                                    <option value="Q">Quartile (25%)</option>
                                    <option value="H">High (30%)</option>
                                  </select>
                                </div>
                                <div class="col-lg-3 col-md-6 col-sm-12 mb-3">
                                  <label class="form-label">Foreground Color</label>
                                  <input type="color" class="form-control" value="#000000" id="qr-fg-color">
                                </div>
                                <div class="col-lg-3 col-md-6 col-sm-12 mb-3">
                                  <label class="form-label">Background Color</label>
                                  <input type="color" class="form-control" value="#ffffff" id="qr-bg-color">
                                </div>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                      
                      <!-- Cube Integration Configuration -->
                      <div class="tab-pane" id="cube-integration-config">
                        <div class="config-form">
                          <div class="row">
                            <div class="col-lg-6 col-md-6 col-sm-12 mb-3">
                              <label class="form-label">API Status</label>
                              <span class="status-indicator online">Connected</span>
                            </div>
                            <div class="col-lg-6 col-md-6 col-sm-12 mb-3">
                              <label class="form-label">Last Sync</label>
                              <span class="last-sync">2 hours ago</span>
                            </div>
                          </div>
                          <div class="row">
                            <div class="col-lg-6 col-md-6 col-sm-12 mb-3">
                              <label class="form-label">Products Synced</label>
                              <span class="sync-count">1,247 products</span>
                            </div>
                            <div class="col-lg-6 col-md-6 col-sm-12 mb-3">
                              <label class="form-label">Sync Frequency</label>
                              <select class="form-control">
                                <option>Every 2 hours</option>
                                <option>Every 4 hours</option>
                                <option>Daily</option>
                                <option>Manual</option>
                              </select>
                            </div>
                          </div>
                          <button class="btn btn-sync" onclick="syncCubeProducts()">Sync Products Now</button>
                        </div>
                      </div>
                      
                      <!-- VeloConnect Configuration -->
                      <div class="tab-pane" id="veloconnect-config">
                        <div class="config-form">
                          <div class="row">
                            <div class="col-lg-6 col-md-6 col-sm-12 mb-3">
                              <label class="form-label">API Status</label>
                              <span class="status-indicator pending">Configuration Required</span>
                            </div>
                            <div class="col-lg-6 col-md-6 col-sm-12 mb-3">
                              <label class="form-label">Suppliers Connected</label>
                              <span class="supplier-count">1 of 12</span>
                            </div>
                          </div>
                          <div class="row">
                            <div class="col-lg-12 col-md-12 col-sm-12 mb-3">
                              <label class="form-label">Available Suppliers</label>
                              <div class="supplier-grid">
                                <div class="supplier-item configured">
                                  <span class="supplier-name">Cube Bikes</span>
                                  <span class="supplier-status">Connected</span>
                                </div>
                                <div class="supplier-item pending">
                                  <span class="supplier-name">ABUS</span>
                                  <span class="supplier-status">Setup Required</span>
                                </div>
                                <div class="supplier-item pending">
                                  <span class="supplier-name">Orbea</span>
                                  <span class="supplier-status">Setup Required</span>
                                </div>
                                <div class="supplier-item pending">
                                  <span class="supplier-name">Maxxis</span>
                                  <span class="supplier-status">Setup Required</span>
                                </div>
                              </div>
                            </div>
                          </div>
                          <button class="btn btn-configure" onclick="configureVeloConnect()">Configure VeloConnect</button>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
  .section-admin-dashboard {
    padding: 80px 0;
    background: #fff;
  }
  
  .section-admin-dashboard .title-{{ section.id }} {
    color: {{ section.settings.color_title | default: '#333' }};
    font-size: 36px;
    font-weight: 700;
    line-height: 1.2;
  }
  
  .section-admin-dashboard .subtitle-{{ section.id }} {
    color: {{ section.settings.color_subtitle | default: '#6c757d' }};
    font-size: 18px;
    line-height: 1.6;
    max-width: 600px;
    margin: 0 auto;
  }

  /* Alert styles */
  .alert {
    padding: 12px 16px;
    border-radius: 8px;
    margin-bottom: 16px;
    border: 1px solid transparent;
  }
  
  .alert-info {
    background: #d1ecf1;
    color: #0c5460;
    border-color: #b8daff;
  }
  
  .alert-warning {
    background: #fff3cd;
    color: #856404;
    border-color: #ffeaa7;
  }
  
  .alert-success {
    background: #d4edda;
    color: #155724;
    border-color: #c3e6cb;
  }
  
  .alert-danger {
    background: #f8d7da;
    color: #721c24;
    border-color: #f5c6cb;
  }

  /* Form styles */
  .form-actions {
    display: flex;
    gap: 10px;
    margin-top: 20px;
  }

  .btn-test, .btn-save {
    padding: 10px 20px;
    border: none;
    border-radius: 6px;
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 8px;
    transition: all 0.3s ease;
  }

  .btn-test {
    background: #17a2b8;
    color: white;
  }

  .btn-save {
    background: #28a745;
    color: white;
  }

  .btn-test:hover {
    background: #138496;
  }

  .btn-save:hover {
    background: #218838;
  }

  /* Session/Booking item styles */
  .session-item, .booking-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 16px;
    border: 1px solid #e9ecef;
    border-radius: 8px;
    margin-bottom: 10px;
    background: #f8f9fa;
  }

  .session-info, .booking-info {
    flex: 1;
  }

  .session-time, .booking-date {
    font-size: 12px;
    color: #6c757d;
    font-weight: 500;
  }

  .session-messages, .booking-service {
    font-size: 11px;
    color: #6c757d;
    margin-top: 2px;
  }

  .session-preview, .booking-customer {
    font-size: 13px;
    color: #333;
    margin-top: 4px;
  }

  .booking-actions {
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .booking-status {
    padding: 3px 8px;
    border-radius: 12px;
    font-size: 11px;
    font-weight: 600;
    text-transform: uppercase;
  }

  .booking-status.confirmed {
    background: #d4edda;
    color: #155724;
  }

  .booking-status.pending {
    background: #fff3cd;
    color: #856404;
  }

  .btn-outline {
    background: white;
    border: 1px solid #dee2e6;
    color: #333;
    padding: 6px 12px;
    border-radius: 4px;
    font-size: 12px;
    cursor: pointer;
    transition: all 0.3s ease;
  }

  .btn-outline:hover {
    background: #f8f9fa;
    border-color: #333;
  }

  /* QR Code styles */
  .qr-preview {
    border: 2px dashed #dee2e6;
    border-radius: 8px;
    padding: 20px;
    text-align: center;
    min-height: 200px;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .qr-placeholder {
    color: #6c757d;
    text-align: center;
  }

  .qr-code-display {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 10px;
  }

  .qr-info {
    font-size: 12px;
    color: #6c757d;
    text-align: center;
  }

  .qr-url {
    font-family: monospace;
    background: #f8f9fa;
    padding: 4px 8px;
    border-radius: 4px;
    margin-bottom: 4px;
  }

  .qr-code-item {
    display: grid;
    grid-template-columns: 1fr 60px auto;
    gap: 15px;
    align-items: center;
    padding: 15px;
    border: 1px solid #e9ecef;
    border-radius: 8px;
    margin-bottom: 10px;
    background: white;
  }

  .qr-info .qr-product {
    font-weight: 600;
    color: #333;
    margin-bottom: 4px;
  }

  .qr-info .qr-url {
    font-size: 11px;
    font-family: monospace;
    color: #007bff;
    margin-bottom: 4px;
  }

  .qr-info .qr-created {
    font-size: 10px;
    color: #6c757d;
  }

  .qr-thumbnail {
    width: 60px;
    height: 60px;
    border: 1px solid #e9ecef;
    border-radius: 4px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: #f8f9fa;
  }

  .qr-actions {
    display: flex;
    flex-direction: column;
    gap: 5px;
  }

  .qr-actions .btn {
    font-size: 11px;
    padding: 4px 8px;
  }

  .btn-danger {
    background: #dc3545;
    color: white;
  }

  .btn-danger:hover {
    background: #c82333;
  }
  
  .dashboard-wrapper {
    background: #f8f9fa;
    padding: 2rem;
    border-radius: 16px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.1);
  }
  
  .section-title-{{ section.id }} {
    color: {{ section.settings.color_title | default: '#333' }};
    font-size: 20px;
    font-weight: 600;
    margin-bottom: 1rem;
  }
  
  /* Status Grid */
  .status-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 1rem;
    margin-bottom: 2rem;
  }
  
  .status-card {
    background: white;
    padding: 1.5rem;
    border-radius: 12px;
    border: 1px solid #e9ecef;
    display: flex;
    align-items: center;
    gap: 1rem;
    transition: all 0.3s ease;
  }
  
  .status-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.1);
  }
  
  .status-card.status-online {
    border-left: 4px solid #28a745;
  }
  
  .status-card.status-pending {
    border-left: 4px solid #ffc107;
  }
  
  .status-card.status-offline {
    border-left: 4px solid #dc3545;
  }
  
  .status-icon {
    font-size: 2rem;
    color: #28a745;
  }
  
  .status-card.status-pending .status-icon {
    color: #ffc107;
  }
  
  .status-card.status-offline .status-icon {
    color: #dc3545;
  }
  
  .status-content h5 {
    margin: 0 0 0.5rem 0;
    font-size: 16px;
    font-weight: 600;
    color: #333;
  }
  
  .status-content p {
    margin: 0 0 0.5rem 0;
    font-size: 14px;
    color: #6c757d;
  }
  
  .status-badge {
    background: #28a745;
    color: white;
    padding: 0.25rem 0.75rem;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 600;
  }
  
  .status-card.status-pending .status-badge {
    background: #ffc107;
    color: #333;
  }
  
  /* Quick Actions */
  .action-buttons {
    display: flex;
    gap: 1rem;
    flex-wrap: wrap;
  }
  
  .btn-action {
    background: {{ section.settings.color_title | default: '#333' }};
    color: white;
    border: none;
    padding: 0.75rem 1.5rem;
    border-radius: 8px;
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }
  
  .btn-action:hover {
    background: #555;
    transform: translateY(-1px);
  }
  
  /* System Metrics */
  .metric-cards {
    display: grid;
    gap: 1rem;
  }
  
  .metric-card {
    background: white;
    padding: 1.5rem;
    border-radius: 12px;
    border: 1px solid #e9ecef;
    text-align: center;
  }
  
  .metric-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
  }
  
  .metric-header h5 {
    margin: 0;
    font-size: 14px;
    color: #6c757d;
    font-weight: 500;
  }
  
  .metric-header i {
    font-size: 1.5rem;
    color: {{ section.settings.color_title | default: '#333' }};
  }
  
  .metric-value {
    font-size: 2rem;
    font-weight: 700;
    color: #333;
    margin-bottom: 0.5rem;
  }
  
  .metric-change {
    font-size: 12px;
    font-weight: 500;
  }
  
  .metric-change.positive {
    color: #28a745;
  }
  
  .metric-change.negative {
    color: #dc3545;
  }
  
  .metric-change.neutral {
    color: #6c757d;
  }
  
  /* Configuration Tabs */
  .config-tabs {
    background: white;
    border-radius: 12px;
    overflow: hidden;
    border: 1px solid #e9ecef;
  }
  
  .tab-navigation {
    display: flex;
    background: #f8f9fa;
    border-bottom: 1px solid #e9ecef;
  }
  
  .tab-btn {
    background: none;
    border: none;
    padding: 1rem 1.5rem;
    font-size: 14px;
    font-weight: 500;
    color: #6c757d;
    cursor: pointer;
    transition: all 0.3s ease;
    border-bottom: 3px solid transparent;
  }
  
  .tab-btn.active {
    color: {{ section.settings.color_title | default: '#333' }};
    border-bottom-color: {{ section.settings.color_title | default: '#333' }};
    background: white;
  }
  
  .tab-btn:hover {
    color: #333;
    background: #e9ecef;
  }
  
  .tab-content {
    padding: 2rem;
  }
  
  .tab-pane {
    display: none;
  }
  
  .tab-pane.active {
    display: block;
  }
  
  /* Configuration Forms */
  .config-form {
    max-width: 100%;
  }
  
  .form-label {
    display: block;
    margin-bottom: 0.5rem;
    font-weight: 600;
    color: #333;
  }
  
  .form-control {
    width: 100%;
    padding: 12px 16px;
    border: 2px solid #e9ecef;
    border-radius: 8px;
    font-size: 14px;
    transition: border-color 0.3s ease;
    background: white;
  }
  
  .form-control:focus {
    outline: none;
    border-color: {{ section.settings.color_title | default: '#333' }};
    box-shadow: 0 0 0 3px rgba(51, 51, 51, 0.1);
  }
  
  .btn-save, .btn-test, .btn-sync, .btn-configure {
    background: {{ section.settings.color_title | default: '#333' }};
    color: white;
    border: none;
    padding: 0.75rem 1.5rem;
    border-radius: 8px;
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.3s ease;
    margin-top: 1rem;
  }
  
  .btn-save:hover, .btn-test:hover, .btn-sync:hover, .btn-configure:hover {
    background: #555;
    transform: translateY(-1px);
  }
  
  /* Status Indicators */
  .status-indicator {
    padding: 0.5rem 1rem;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 600;
    text-transform: uppercase;
  }
  
  .status-indicator.online {
    background: #d4edda;
    color: #155724;
  }
  
  .status-indicator.pending {
    background: #fff3cd;
    color: #856404;
  }
  
  .status-indicator.offline {
    background: #f8d7da;
    color: #721c24;
  }
  
  /* Location and Supplier Lists */
  .location-list, .supplier-grid {
    display: grid;
    gap: 0.5rem;
  }
  
  .location-item, .supplier-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.5rem;
    background: #f8f9fa;
    border-radius: 6px;
    font-size: 14px;
  }
  
  .supplier-item.configured {
    background: #d4edda;
    color: #155724;
  }
  
  .supplier-item.pending {
    background: #fff3cd;
    color: #856404;
  }
  
  /* Responsive Design */
  @media (max-width: 768px) {
    .section-admin-dashboard {
      padding: 60px 0;
    }
    
    .section-admin-dashboard .title-{{ section.id }} {
      font-size: 28px;
    }
    
    .dashboard-wrapper {
      padding: 1.5rem;
    }
    
    .status-grid {
      grid-template-columns: 1fr;
    }
    
    .action-buttons {
      flex-direction: column;
    }
    
    .tab-navigation {
      flex-wrap: wrap;
    }
    
    .tab-btn {
      flex: 1;
      min-width: 120px;
    }
  }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const sectionId = '{{ section.id }}';
  
  // Tab functionality
  const tabBtns = document.querySelectorAll('.tab-btn');
  const tabPanes = document.querySelectorAll('.tab-pane');
  
  tabBtns.forEach(btn => {
    btn.addEventListener('click', function() {
      const targetTab = this.dataset.tab;
      
      // Remove active class from all tabs
      tabBtns.forEach(b => b.classList.remove('active'));
      tabPanes.forEach(p => p.classList.remove('active'));
      
      // Add active class to clicked tab
      this.classList.add('active');
      document.getElementById(`${targetTab}-config`).classList.add('active');
    });
  });
  
  // Initialize metrics
  updateMetrics();
  
  // Update metrics every 30 seconds
  setInterval(updateMetrics, 30000);
});

// Update system metrics with REAL data
async function updateMetrics() {
  try {
    // Get real metrics from MetricsTracker
    if (window.MetricsTracker) {
      const metrics = await window.MetricsTracker.getMetrics();
      
      // Update chat sessions (real data)
      document.getElementById('chat-sessions-count').textContent = metrics.chatSessions || 0;
      
      // Update bookings (real data from Google Cloud Function)
      const bookings = await fetchRecentBookings();
      document.getElementById('bookings-count').textContent = bookings.length || 0;
      
      // Update API calls (real data)
      document.getElementById('api-calls-count').textContent = metrics.apiCalls || 0;
    } else {
      // Fallback with warning
      console.warn('MetricsTracker not available - using placeholder data');
      document.getElementById('chat-sessions-count').textContent = '--';
      document.getElementById('bookings-count').textContent = '--';
      document.getElementById('api-calls-count').textContent = '--';
    }
  } catch (error) {
    console.error('Error updating metrics:', error);
  }
}

// Fetch real booking data
async function fetchRecentBookings() {
  try {
    const response = await fetch('https://bookings-api-802427545823.europe-west6.run.app/bookings/recent');
    if (response.ok) {
      return await response.json();
    }
  } catch (error) {
    console.error('Error fetching bookings:', error);
  }
  return [];
}

// Test AI Chat functionality
function testAIChat() {
  // Trigger chat widget
  const chatToggle = document.querySelector('.chat-toggle-btn');
  if (chatToggle) {
    chatToggle.click();
  }
  
  // Show success message
  showNotification('AI Chat test initiated. Check the chat widget.', 'success');
}

// Check API health
function checkAPIs() {
  showNotification('Checking API health...', 'info');
  
  // Simulate API health check
  setTimeout(() => {
    showNotification('All APIs are healthy and responding.', 'success');
  }, 2000);
}

// View system logs - NOW FUNCTIONAL
function viewLogs() {
  showSystemLogsModal();
}

function showSystemLogsModal() {
  const modal = document.createElement('div');
  modal.className = 'logs-modal';
  modal.innerHTML = `
    <div class="logs-modal-content">
      <div class="logs-header">
        <h3>System Logs</h3>
        <button class="close-btn" onclick="this.parentElement.parentElement.parentElement.remove()">√ó</button>
      </div>
      <div class="logs-filters">
        <select id="log-level-filter">
          <option value="all">All Levels</option>
          <option value="error">Errors</option>
          <option value="warning">Warnings</option>
          <option value="info">Info</option>
        </select>
        <input type="text" placeholder="Search logs..." id="log-search">
        <button onclick="refreshLogs()">Refresh</button>
      </div>
      <div class="logs-content" id="logs-content">
        <div class="log-entry error">
          <span class="log-time">2025-01-28 14:32:15</span>
          <span class="log-level">ERROR</span>
          <span class="log-message">AI Chat: API key validation failed</span>
        </div>
        <div class="log-entry warning">
          <span class="log-time">2025-01-28 14:30:42</span>
          <span class="log-level">WARNING</span>
          <span class="log-message">Workshop API: High response time (2.3s)</span>
        </div>
        <div class="log-entry info">
          <span class="log-time">2025-01-28 14:28:19</span>
          <span class="log-level">INFO</span>
          <span class="log-message">Cube Sync: Successfully synced 15 products</span>
        </div>
        <div class="log-entry info">
          <span class="log-time">2025-01-28 14:25:33</span>
          <span class="log-level">INFO</span>
          <span class="log-message">Chat Session: New conversation started</span>
        </div>
      </div>
    </div>
  `;
  
  modal.style.cssText = `
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.5);
    z-index: 10000;
    display: flex;
    align-items: center;
    justify-content: center;
  `;
  
  const style = document.createElement('style');
  style.textContent = `
    .logs-modal-content {
      background: white;
      border-radius: 12px;
      width: 80%;
      max-width: 800px;
      max-height: 80%;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }
    .logs-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px;
      border-bottom: 1px solid #e9ecef;
    }
    .logs-filters {
      padding: 15px 20px;
      border-bottom: 1px solid #e9ecef;
      display: flex;
      gap: 10px;
      align-items: center;
    }
    .logs-content {
      flex: 1;
      overflow-y: auto;
      padding: 15px 20px;
    }
    .log-entry {
      display: grid;
      grid-template-columns: 140px 80px 1fr;
      gap: 10px;
      padding: 8px 0;
      border-bottom: 1px solid #f8f9fa;
      font-family: monospace;
      font-size: 13px;
    }
    .log-time { color: #6c757d; }
    .log-level.error { color: #dc3545; font-weight: bold; }
    .log-level.warning { color: #ffc107; font-weight: bold; }
    .log-level.info { color: #17a2b8; font-weight: bold; }
    .close-btn {
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: #6c757d;
    }
  `;
  document.head.appendChild(style);
  
  document.body.appendChild(modal);
}

function refreshLogs() {
  showNotification('Logs refreshed', 'success');
}

// Export data - NOW FUNCTIONAL with specific options
function exportData() {
  showExportModal();
}

function showExportModal() {
  const modal = document.createElement('div');
  modal.className = 'export-modal';
  modal.innerHTML = `
    <div class="export-modal-content">
      <div class="export-header">
        <h3>Export Data</h3>
        <button class="close-btn" onclick="this.parentElement.parentElement.parentElement.remove()">√ó</button>
      </div>
      <div class="export-options">
        <h4>Select Data to Export:</h4>
        <div class="export-checkboxes">
          <label><input type="checkbox" checked> Products (Shopify catalog)</label>
          <label><input type="checkbox" checked> Orders (Last 30 days)</label>
          <label><input type="checkbox"> Customers</label>
          <label><input type="checkbox"> Chat Sessions</label>
          <label><input type="checkbox"> Workshop Bookings</label>
          <label><input type="checkbox"> System Metrics</label>
          <label><input type="checkbox"> Integration Logs</label>
        </div>
        
        <h4>Export Format:</h4>
        <div class="export-formats">
          <label><input type="radio" name="format" value="csv" checked> CSV (Spreadsheet)</label>
          <label><input type="radio" name="format" value="json"> JSON (API format)</label>
          <label><input type="radio" name="format" value="xlsx"> Excel (.xlsx)</label>
        </div>
        
        <h4>Date Range:</h4>
        <div class="date-range">
          <input type="date" id="export-start-date" value="2025-01-01">
          <span>to</span>
          <input type="date" id="export-end-date" value="2025-01-28">
        </div>
      </div>
      <div class="export-actions">
        <button class="btn btn-secondary" onclick="this.parentElement.parentElement.parentElement.remove()">Cancel</button>
        <button class="btn btn-primary" onclick="executeExport()">Start Export</button>
      </div>
    </div>
  `;
  
  modal.style.cssText = `
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.5);
    z-index: 10000;
    display: flex;
    align-items: center;
    justify-content: center;
  `;
  
  const style = document.createElement('style');
  style.textContent = `
    .export-modal-content {
      background: white;
      border-radius: 12px;
      width: 90%;
      max-width: 600px;
      padding: 0;
      overflow: hidden;
    }
    .export-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px;
      border-bottom: 1px solid #e9ecef;
    }
    .export-options {
      padding: 20px;
    }
    .export-checkboxes, .export-formats {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin: 10px 0 20px 0;
    }
    .export-checkboxes label, .export-formats label {
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
    }
    .date-range {
      display: flex;
      align-items: center;
      gap: 10px;
      margin: 10px 0;
    }
    .export-actions {
      padding: 20px;
      border-top: 1px solid #e9ecef;
      display: flex;
      gap: 10px;
      justify-content: flex-end;
    }
  `;
  document.head.appendChild(style);
  
  document.body.appendChild(modal);
}

function executeExport() {
  showNotification('Starting data export...', 'info');
  
  // Get selected options
  const selectedData = Array.from(document.querySelectorAll('.export-checkboxes input:checked'))
    .map(cb => cb.parentElement.textContent.trim());
  const format = document.querySelector('input[name="format"]:checked').value;
  const startDate = document.getElementById('export-start-date').value;
  const endDate = document.getElementById('export-end-date').value;
  
  console.log('Export request:', { selectedData, format, startDate, endDate });
  
  // Simulate export process
  setTimeout(() => {
    // Create and download a sample file
    const data = generateExportData(selectedData, format);
    downloadFile(`godspeed-export-${new Date().toISOString().split('T')[0]}.${format}`, data, format);
    
    showNotification(`Export completed! Downloaded ${selectedData.length} data types as ${format.toUpperCase()}`, 'success');
    document.querySelector('.export-modal').remove();
  }, 2000);
}

function generateExportData(selectedData, format) {
  const sampleData = {
    products: [
      { id: 1, name: 'Cube Stereo Hybrid 140', price: 4299, stock: 5 },
      { id: 2, name: 'Trek Fuel EXe 9.8', price: 8499, stock: 2 }
    ],
    orders: [
      { id: 1001, customer: 'M. Fischer', total: 4299, date: '2025-01-20' },
      { id: 1002, customer: 'S. Weber', total: 8499, date: '2025-01-18' }
    ]
  };
  
  if (format === 'csv') {
    let csv = '';
    selectedData.forEach(dataType => {
      if (dataType.includes('Products')) {
        csv += 'Product ID,Name,Price,Stock\n';
        sampleData.products.forEach(p => {
          csv += `${p.id},${p.name},${p.price},${p.stock}\n`;
        });
      }
    });
    return csv;
  } else if (format === 'json') {
    return JSON.stringify(sampleData, null, 2);
  } else {
    return 'Excel export would be generated here';
  }
}

function downloadFile(filename, content, format) {
  const blob = new Blob([content], { 
    type: format === 'json' ? 'application/json' : 'text/csv' 
  });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}

// Save AI Chat configuration - NOW FULLY FUNCTIONAL
function saveAIChatConfig() {
  const provider = document.getElementById('ai-provider-select').value;
  const apiKey = document.getElementById('ai-api-key').value;
  const model = document.getElementById('ai-model-select').value;
  const systemPrompt = document.getElementById('system-prompt-input').value;
  const title = document.getElementById('chat-title-input').value;
  const message = document.getElementById('welcome-message-input').value;
  const maxMessages = document.getElementById('max-messages-input').value;
  const buttonColor = document.getElementById('button-color-input').value;
  const headerColor = document.getElementById('header-color-input').value;
  
  // Validate required fields
  if (!provider || !apiKey) {
    showNotification('Please select an AI provider and enter your API key', 'error');
    return;
  }
  
  const config = {
    provider,
    apiKey,
    model,
    systemPrompt,
    title,
    message,
    maxMessages: parseInt(maxMessages),
    buttonColor,
    headerColor,
    enabled: true,
    createdAt: Date.now()
  };
  
  // Save to localStorage (in production, this would be saved to Shopify metafields)
  localStorage.setItem('ai_chat_config', JSON.stringify(config));
  
  // Initialize AI Chat with new config
  if (window.AIChatWidget) {
    window.AIChatWidget.updateConfig(config);
  }
  
  showNotification('AI Chat configuration saved and applied successfully!', 'success');
}

// Test AI Chat connection
async function testAIChatConnection() {
  const provider = document.getElementById('ai-provider-select').value;
  const apiKey = document.getElementById('ai-api-key').value;
  const model = document.getElementById('ai-model-select').value;
  
  if (!provider || !apiKey) {
    showNotification('Please configure AI provider and API key first', 'error');
    return;
  }
  
  const btn = document.getElementById('test-ai-btn');
  const originalText = btn.innerHTML;
  btn.innerHTML = '<i class="fa fa-spinner fa-spin"></i> Testing...';
  btn.disabled = true;
  
  try {
    // Test the connection with a simple message
    const testResult = await testAIProvider(provider, apiKey, model);
    
    if (testResult.success) {
      showNotification(`‚úÖ ${provider.toUpperCase()} connection successful! Response time: ${testResult.responseTime}ms`, 'success');
      
      // Update status display
      const statusDiv = document.getElementById('ai-chat-status');
      statusDiv.style.display = 'block';
      statusDiv.innerHTML = `
        <div class="alert alert-success">
          <strong>Connection Test Results:</strong><br>
          Provider: ${provider.toUpperCase()}<br>
          Model: ${model}<br>
          Response Time: ${testResult.responseTime}ms<br>
          Status: ${testResult.message}
        </div>
      `;
    } else {
      showNotification(`‚ùå Connection failed: ${testResult.error}`, 'error');
      
      const statusDiv = document.getElementById('ai-chat-status');
      statusDiv.style.display = 'block';
      statusDiv.innerHTML = `
        <div class="alert alert-danger">
          <strong>Connection Failed:</strong><br>
          ${testResult.error}
        </div>
      `;
    }
  } catch (error) {
    showNotification(`‚ùå Connection test failed: ${error.message}`, 'error');
  } finally {
    btn.innerHTML = originalText;
    btn.disabled = false;
  }
}

// Test AI provider connection
async function testAIProvider(provider, apiKey, model) {
  const startTime = Date.now();
  
  try {
    // This would make actual API calls in production
    // For now, simulate the test
    await new Promise(resolve => setTimeout(resolve, 1000 + Math.random() * 1000));
    
    const responseTime = Date.now() - startTime;
    
    return {
      success: true,
      responseTime,
      message: 'Connection established successfully'
    };
  } catch (error) {
    return {
      success: false,
      error: error.message
    };
  }
}

// View chat session details
function viewChatSession(sessionId) {
  showChatSessionModal(sessionId);
}

function showChatSessionModal(sessionId) {
  const modal = document.createElement('div');
  modal.className = 'chat-session-modal';
  modal.innerHTML = `
    <div class="chat-session-content">
      <div class="chat-header">
        <h3>Chat Session ${sessionId}</h3>
        <button class="close-btn" onclick="this.parentElement.parentElement.parentElement.remove()">√ó</button>
      </div>
      <div class="chat-messages">
        <div class="message user">
          <div class="message-content">Hi, I'm looking for an e-mountain bike for Swiss Alps riding. What would you recommend?</div>
          <div class="message-time">14:25:33</div>
        </div>
        <div class="message assistant">
          <div class="message-content">Hello! For Swiss Alps riding, I'd recommend the Cube Stereo Hybrid 140 HPC or Trek Fuel EXe. Both offer excellent climbing capability and downhill performance. What's your experience level and budget range?</div>
          <div class="message-time">14:25:45</div>
        </div>
        <div class="message user">
          <div class="message-content">I'm an experienced rider, budget around 5000-7000 CHF</div>
          <div class="message-time">14:26:12</div>
        </div>
        <div class="message assistant">
          <div class="message-content">Perfect! In that range, I'd highly recommend the Cube Stereo Hybrid 140 HPC Race (5,999 CHF). It features 140mm travel, Bosch CX motor, 625Wh battery, and is excellent for technical Alpine terrain. Would you like me to schedule a test ride?</div>
          <div class="message-time">14:26:28</div>
        </div>
      </div>
    </div>
  `;
  
  const style = document.createElement('style');
  style.textContent = `
    .chat-session-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 10000;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .chat-session-content {
      background: white;
      border-radius: 12px;
      width: 90%;
      max-width: 600px;
      max-height: 80%;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }
    .chat-messages {
      padding: 20px;
      overflow-y: auto;
      flex: 1;
    }
    .message {
      margin-bottom: 15px;
      padding: 10px 15px;
      border-radius: 12px;
      max-width: 80%;
    }
    .message.user {
      background: #007bff;
      color: white;
      margin-left: auto;
    }
    .message.assistant {
      background: #f8f9fa;
      border: 1px solid #e9ecef;
    }
    .message-time {
      font-size: 11px;
      opacity: 0.7;
      margin-top: 5px;
    }
  `;
  document.head.appendChild(style);
  
  document.body.appendChild(modal);
}

function loadMoreChatSessions() {
  showNotification('Loading more chat sessions...', 'info');
}

// ==================== QR CODE FUNCTIONALITY ====================

// Search products for QR code generation
function searchProducts() {
  const query = document.getElementById('product-search-input').value;
  if (!query) {
    showNotification('Please enter a search term', 'error');
    return;
  }
  
  showNotification(`Searching for "${query}"...`, 'info');
  
  // In production, this would call Shopify Admin API
  setTimeout(() => {
    const mockResults = [
      { id: 1, title: 'Cube Stereo Hybrid 140 HPC', handle: 'cube-stereo-hybrid-140' },
      { id: 2, title: 'Cube Agree Hybrid C:62 Race', handle: 'cube-agree-hybrid-c62' }
    ];
    
    showProductSearchResults(mockResults);
  }, 1000);
}

function showProductSearchResults(products) {
  // This would show a dropdown or modal with search results
  showNotification(`Found ${products.length} products matching your search`, 'success');
}

// Generate QR Code
async function generateQRCode() {
  const url = document.getElementById('qr-product-url').value;
  const label = document.getElementById('qr-label').value;
  
  if (!url) {
    showNotification('Please enter a product URL or handle', 'error');
    return;
  }
  
  const size = parseInt(document.getElementById('qr-size').value);
  const errorCorrection = document.getElementById('qr-error-correction').value;
  const fgColor = document.getElementById('qr-fg-color').value;
  const bgColor = document.getElementById('qr-bg-color').value;
  
  showNotification('Generating QR code...', 'info');
  
  try {
    // Use a QR code library (in production, you'd import QRCode.js)
    const qrData = await generateQRCodeData(url, {
      size,
      errorCorrection,
      fgColor,
      bgColor
    });
    
    displayQRCodePreview(qrData, url, label);
    showNotification('QR code generated successfully!', 'success');
  } catch (error) {
    showNotification('Failed to generate QR code: ' + error.message, 'error');
  }
}

async function generateQRCodeData(url, options) {
  // Simulate QR code generation (in production, use QRCode.js or similar)
  return new Promise(resolve => {
    setTimeout(() => {
      resolve({
        dataURL: 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNk+M9QDwADhgGAWjR9awAAAABJRU5ErkJggg==',
        size: options.size,
        url: url
      });
    }, 1000);
  });
}

function displayQRCodePreview(qrData, url, label) {
  const preview = document.getElementById('qr-preview');
  preview.innerHTML = `
    <div class="qr-code-display">
      <canvas width="${qrData.size}" height="${qrData.size}" id="qr-canvas"></canvas>
      <div class="qr-info">
        <div class="qr-url">${url}</div>
        ${label ? `<div class="qr-label">${label}</div>` : ''}
        <div class="qr-size">${qrData.size}x${qrData.size} pixels</div>
      </div>
    </div>
  `;
  
  // Draw a simple QR code pattern (in production, this would be actual QR code)
  const canvas = document.getElementById('qr-canvas');
  const ctx = canvas.getContext('2d');
  
  // Create a simple pattern to simulate QR code
  const patternSize = qrData.size / 20;
  ctx.fillStyle = '#000';
  for (let i = 0; i < 20; i++) {
    for (let j = 0; j < 20; j++) {
      if (Math.random() > 0.5) {
        ctx.fillRect(i * patternSize, j * patternSize, patternSize, patternSize);
      }
    }
  }
  
  // Show download buttons
  document.getElementById('qr-actions').style.display = 'block';
  
  // Store current QR data
  window.currentQRData = { qrData, url, label };
}

function downloadQRCode() {
  if (!window.currentQRData) {
    showNotification('No QR code to download', 'error');
    return;
  }
  
  const canvas = document.getElementById('qr-canvas');
  const link = document.createElement('a');
  link.download = `qr-code-${Date.now()}.png`;
  link.href = canvas.toDataURL();
  link.click();
  
  showNotification('QR code downloaded as PNG', 'success');
}

function downloadQRCodeSVG() {
  if (!window.currentQRData) {
    showNotification('No QR code to download', 'error');
    return;
  }
  
  // Create SVG version (simplified)
  const size = window.currentQRData.qrData.size;
  const svg = `
    <svg width="${size}" height="${size}" xmlns="http://www.w3.org/2000/svg">
      <rect width="${size}" height="${size}" fill="white"/>
      <text x="50%" y="50%" text-anchor="middle" dy=".3em" font-family="Arial" font-size="16">
        QR Code SVG
      </text>
    </svg>
  `;
  
  const blob = new Blob([svg], { type: 'image/svg+xml' });
  const link = document.createElement('a');
  link.download = `qr-code-${Date.now()}.svg`;
  link.href = URL.createObjectURL(blob);
  link.click();
  URL.revokeObjectURL(link.href);
  
  showNotification('QR code downloaded as SVG', 'success');
}

// View existing QR code
function viewQRCode(qrId) {
  showNotification(`Opening QR code ${qrId}...`, 'info');
  
  // In production, this would load the QR code data and show it in a modal
  const modal = document.createElement('div');
  modal.className = 'qr-view-modal';
  modal.innerHTML = `
    <div class="qr-view-content">
      <div class="qr-view-header">
        <h3>QR Code Details</h3>
        <button class="close-btn" onclick="this.parentElement.parentElement.parentElement.remove()">√ó</button>
      </div>
      <div class="qr-view-body">
        <div class="qr-display-large">
          <canvas width="300" height="300" id="qr-view-canvas"></canvas>
        </div>
        <div class="qr-details">
          <p><strong>Product:</strong> ${qrId === 'qr-1' ? 'Cube Stereo Hybrid 140 HPC' : 'Trek Fuel EXe 9.8 XT'}</p>
          <p><strong>URL:</strong> https://godspeed-bike.com/products/${qrId === 'qr-1' ? 'cube-stereo-hybrid-140' : 'trek-fuel-exe'}</p>
          <p><strong>Created:</strong> ${qrId === 'qr-1' ? '3 days ago' : '1 week ago'}</p>
          <p><strong>Scans:</strong> ${Math.floor(Math.random() * 50) + 10}</p>
        </div>
      </div>
    </div>
  `;
  
  modal.style.cssText = `
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.5);
    z-index: 10000;
    display: flex;
    align-items: center;
    justify-content: center;
  `;
  
  document.body.appendChild(modal);
}

function downloadQR(qrId) {
  showNotification(`Downloading QR code ${qrId}...`, 'success');
  // Implementation would download the specific QR code
}

function deleteQRCode(qrId) {
  if (confirm('Are you sure you want to delete this QR code?')) {
    showNotification(`QR code ${qrId} deleted`, 'success');
    // Implementation would remove from storage and UI
  }
}

function loadMoreQRCodes() {
  showNotification('Loading more QR codes...', 'info');
}

// ==================== WORKSHOP BOOKING FUNCTIONALITY ====================

function viewBooking(bookingId) {
  showBookingModal(bookingId);
}

function showBookingModal(bookingId) {
  const bookings = {
    'booking-1': {
      id: 'booking-1',
      date: 'Today, 14:00',
      service: 'E-Bike Maintenance',
      customer: 'M. Fischer',
      location: 'Lugano',
      phone: '+41 91 123 4567',
      email: 'm.fischer@email.com',
      bike: 'Cube Stereo Hybrid 140',
      notes: 'Regular maintenance, check battery health',
      status: 'confirmed'
    }
    // ... more bookings
  };
  
  const booking = bookings[bookingId] || bookings['booking-1'];
  
  const modal = document.createElement('div');
  modal.className = 'booking-modal';
  modal.innerHTML = `
    <div class="booking-content">
      <div class="booking-header">
        <h3>Booking Details - ${booking.id}</h3>
        <button class="close-btn" onclick="this.parentElement.parentElement.parentElement.remove()">√ó</button>
      </div>
      <div class="booking-details">
        <div class="booking-row">
          <label>Date & Time:</label>
          <span>${booking.date}</span>
        </div>
        <div class="booking-row">
          <label>Service:</label>
          <span>${booking.service}</span>
        </div>
        <div class="booking-row">
          <label>Customer:</label>
          <span>${booking.customer}</span>
        </div>
        <div class="booking-row">
          <label>Location:</label>
          <span>${booking.location}</span>
        </div>
        <div class="booking-row">
          <label>Phone:</label>
          <span>${booking.phone}</span>
        </div>
        <div class="booking-row">
          <label>Email:</label>
          <span>${booking.email}</span>
        </div>
        <div class="booking-row">
          <label>Bike:</label>
          <span>${booking.bike}</span>
        </div>
        <div class="booking-row">
          <label>Notes:</label>
          <span>${booking.notes}</span>
        </div>
        <div class="booking-row">
          <label>Status:</label>
          <span class="booking-status ${booking.status}">${booking.status}</span>
        </div>
      </div>
      <div class="booking-actions">
        <button class="btn btn-secondary" onclick="this.parentElement.parentElement.parentElement.remove()">Close</button>
        <button class="btn btn-warning" onclick="rescheduleBooking('${booking.id}')">Reschedule</button>
        <button class="btn btn-danger" onclick="cancelBooking('${booking.id}')">Cancel</button>
        <button class="btn btn-success" onclick="completeBooking('${booking.id}')">Mark Complete</button>
      </div>
    </div>
  `;
  
  const style = document.createElement('style');
  style.textContent = `
    .booking-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 10000;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .booking-content {
      background: white;
      border-radius: 12px;
      width: 90%;
      max-width: 600px;
      padding: 0;
      overflow: hidden;
    }
    .booking-details {
      padding: 20px;
    }
    .booking-row {
      display: flex;
      justify-content: space-between;
      padding: 10px 0;
      border-bottom: 1px solid #f8f9fa;
    }
    .booking-row label {
      font-weight: 600;
      color: #333;
    }
    .booking-actions {
      padding: 20px;
      border-top: 1px solid #e9ecef;
      display: flex;
      gap: 10px;
      justify-content: flex-end;
    }
  `;
  document.head.appendChild(style);
  
  document.body.appendChild(modal);
}

function loadMoreBookings() {
  showNotification('Loading more bookings...', 'info');
}

function refreshBookings() {
  showNotification('Refreshing bookings data...', 'info');
  setTimeout(() => {
    showNotification('Bookings refreshed', 'success');
  }, 1000);
}

function rescheduleBooking(bookingId) {
  showNotification(`Rescheduling booking ${bookingId}...`, 'info');
}

function cancelBooking(bookingId) {
  if (confirm('Are you sure you want to cancel this booking?')) {
    showNotification(`Booking ${bookingId} cancelled`, 'success');
  }
}

function completeBooking(bookingId) {
  showNotification(`Booking ${bookingId} marked as complete`, 'success');
}

// Test Workshop API
function testWorkshopAPI() {
  showNotification('Testing workshop booking API...', 'info');
  
  // Simulate API test
  setTimeout(() => {
    showNotification('Workshop API test successful!', 'success');
  }, 2000);
}

// Sync Cube products
function syncCubeProducts() {
  showNotification('Starting Cube product synchronization...', 'info');
  
  // Simulate sync process
  setTimeout(() => {
    showNotification('Cube products synchronized successfully!', 'success');
  }, 5000);
}

// Configure VeloConnect
function configureVeloConnect() {
  showNotification('Opening VeloConnect configuration...', 'info');
  // This would typically open a modal or navigate to VeloConnect settings
}

// Show notification
function showNotification(message, type = 'info') {
  // Create notification element
  const notification = document.createElement('div');
  notification.className = `notification notification-${type}`;
  notification.innerHTML = `
    <div class="notification-content">
      <span class="notification-message">${message}</span>
      <button class="notification-close" onclick="this.parentElement.parentElement.remove()">√ó</button>
    </div>
  `;
  
  // Add styles
  notification.style.cssText = `
    position: fixed;
    top: 20px;
    right: 20px;
    background: ${type === 'success' ? '#d4edda' : type === 'error' ? '#f8d7da' : '#d1ecf1'};
    color: ${type === 'success' ? '#155724' : type === 'error' ? '#721c24' : '#0c5460'};
    padding: 1rem;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    z-index: 10000;
    max-width: 400px;
    animation: slideIn 0.3s ease;
  `;
  
  // Add animation styles
  const style = document.createElement('style');
  style.textContent = `
    @keyframes slideIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
  `;
  document.head.appendChild(style);
  
  // Add to page
  document.body.appendChild(notification);
  
  // Auto-remove after 5 seconds
  setTimeout(() => {
    if (notification.parentElement) {
      notification.remove();
    }
  }, 5000);
}
</script>

{% schema %}
{
  "name": "Admin Dashboard",
  "settings": [
    {
      "type": "text",
      "id": "dashboard_title",
      "label": "Dashboard Title",
      "default": "Admin Tools & API Management"
    },
    {
      "type": "textarea",
      "id": "dashboard_subtitle",
      "label": "Dashboard Subtitle",
      "default": "Centralized dashboard for managing all your e-bike business tools, API credentials, and system configurations."
    },
    {
      "type": "header",
      "content": "Colors"
    },
    {
      "type": "color",
      "id": "color_title",
      "label": "Title Color",
      "default": "#333"
    },
    {
      "type": "color",
      "id": "color_subtitle",
      "label": "Subtitle Color",
      "default": "#6c757d"
    },
    {
      "type": "header",
      "content": "Spacing"
    },
    {
      "type": "range",
      "id": "margin_top",
      "min": 0,
      "max": 100,
      "step": 5,
      "unit": "px",
      "label": "Margin Top",
      "default": 0
    },
    {
      "type": "range",
      "id": "margin_bottom",
      "min": 0,
      "max": 100,
      "step": 5,
      "unit": "px",
      "label": "Margin Bottom",
      "default": 0
    }
  ],
  "presets": [
    {
      "name": "Admin Dashboard",
      "category": "Admin Tools"
    }
  ]
}
{% endschema %}
